<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Main Page</title>

    <!-- ìŠ¤íƒ€ì¼ & ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <link rel="stylesheet" href="css/MainPage.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.css">
    
    <script src="js/jquery-3.6.0.min.js"></script>    
    <script src="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.js"></script>
    <script src="js/core.js"></script>
</head>
<body>
    <div class="header">
        <h1>MOLE</h1>
    </div>

    <div class="ongoing-projects">
        <div class="ongoing-header">
            <h2>On Going</h2>
            <button id="addProjectBtn" class="add-project-btn">í”„ë¡œì íŠ¸ ì¶”ê°€</button>
        </div>
        <div class="scroll-container">
            <div class="project-list-wrapper">
                <div class="project-list" id="projectList">
                    <!-- JavaScriptë¡œ ë™ì ìœ¼ë¡œ ì¶”ê°€ë  ì˜ˆì • -->
                </div>
            </div>
        </div>
    </div>

    <div class="recent-and-gantt">
        <div class="box-col">
            <h2 class="title">Recent Issue</h2>
            <div class="recent-issue-container">
                <div class="recent-issues" id="issueList">
                </div>
            </div>
        </div>

        <!-- âœ… Gantt Chart ì˜ì—­ -->
        <div class="gantt-chart-container">
    		<h2 class="title">Gantt Chart</h2>
    		<div id="ganttChart" style="width: 100%; height: 500px;"></div>
		</div>

    </div>

    <div class="profile-container">
        <img src="public/logo-transparent.png" alt="MOLE PMS Logo" class="profile-btn" id="profileBtn">
        <div class="profile-menu" id="profileMenu">
            <ul>
                <li data-link="MainPage.html">í™ˆ</li>
                <li data-link="TeamPage.html">íŒ€ í˜ì´ì§€</li>
                <li data-link="ProfilePage.html">í”„ë¡œí•„</li>
                <li data-link="jsp/logout.jsp">ë¡œê·¸ì•„ì›ƒ</li>
            </ul>
        </div>
    </div>

    <!-- í”„ë¡œì íŠ¸ ì¶”ê°€ ëª¨ë‹¬ ì°½ -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <img src="public/logo-transparent.png" alt="MOLE Logo" class="modal-logo">
            <h2>ìƒˆë¡œìš´ í”„ë¡œì íŠ¸</h2>

            <label for="projectName">í”„ë¡œì íŠ¸ ì´ë¦„</label>
            <input type="text" id="projectName" placeholder="í”„ë¡œì íŠ¸ ì´ë¦„ì„ ì…ë ¥">

            <label for="projectOwner">í”„ë¡œì íŠ¸ ì†Œìœ ì</label>
            <input type="text" id="projectOwner" placeholder="í˜„ì¬ í”„ë¡œì íŠ¸ë¥¼ ë§Œë“œëŠ” ìœ ì €ëª…">

            <label for="projectDesc">í”„ë¡œì íŠ¸ ì„¤ëª…</label>
            <input type="text" id="projectDesc" placeholder="í”„ë¡œì íŠ¸ ì„¤ëª…ì„ ì…ë ¥">

            <button id="createProjectBtn">í”„ë¡œì íŠ¸ ë§Œë“¤ê¸°</button>
        </div>
    </div>

    <script>
    let userId;
    let projectData = {}; // í”„ë¡œì íŠ¸ ë°ì´í„° ì €ì¥ ë³€ìˆ˜
    
 	// âœ… Gantt Chart ì´ˆê¸°í™” ë° í”„ë¡œì íŠ¸ ë¡œë“œ
    window.addEventListener("DOMContentLoaded", function () {
        gantt.init("ganttChart");
        gantt.config.date_grid = "%Y-%m-%d %H:%i:%s"; // âœ… ëª©ë¡ì—ì„œë„ ì´ˆ ë‹¨ìœ„ê¹Œì§€ ì¶œë ¥
        //gantt.config.date_scale = "%Y-%m-%d %H:%i"; // âœ… ìƒë‹¨ ìŠ¤ì¼€ì¼ì—ì„œ ì‹œê°„ê¹Œì§€ í‘œì‹œ
        gantt.config.xml_date = "%Y-%m-%d %H:%i"; // âœ… Ganttì—ì„œ ì§€ì›í•˜ëŠ” ë‚ ì§œ í˜•ì‹ ì„¤ì •
    });
    
    $(document).ready(function () {
    	// ì„¸ì…˜ í™•ì¸ í›„ ë¡œê·¸ì¸ ì—¬ë¶€ ì²´í¬
        $.ajax({
            url: "jsp/session.jsp",
            type: "GET",
            success: function(response) {
                if (response.includes("ë¡œê·¸ì¸í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")) {
                    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                    window.location.href = "index.html"; // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                }
                else{
                	userId = response; // ì„¸ì…˜ì—ì„œ ì‚¬ìš©ì IDë¥¼ ê°€ì ¸ì˜¤ëŠ” ë¶€ë¶„
                	console.log(userId);
                    loadProjects(); // í”„ë¡œì íŠ¸ ë¡œë“œ
                    loadIssues();
                }
            },
            error: function(xhr, status, error) {
                console.error("ì„¸ì…˜ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            }
        });
		
      $(".sidebar-link, .profile-menu li").on("click", function () {
          const targetPage = $(this).data("link");
          window.location.href = targetPage;
      });

      // ğŸ“Œ í”„ë¡œí•„ ë²„íŠ¼ í´ë¦­ ì‹œ ë©”ë‰´ í† ê¸€
      const profileBtn = $("#profileBtn");
      const profileMenu = $("#profileMenu");

      profileBtn.on("click", function (event) {
          event.stopPropagation();
          profileMenu.toggleClass("active");
      });

      $(document).on("click", function (event) {
          if (!profileBtn.is(event.target) && !profileMenu.is(event.target) && profileMenu.has(event.target).length === 0) {
              profileMenu.removeClass("active");
          }
      });
      
      
      const projectWrapper = $(".project-list-wrapper");

      function loadProjects() {
    	    $.ajax({
    	        url: "jsp/GetUserProjects.jsp",
    	        type: "GET",
    	        dataType: "json",
    	        success: function (projects) {
    	            console.log("âœ… ì‚¬ìš©ì í”„ë¡œì íŠ¸ ë°ì´í„° ìˆ˜ì‹ :", projects);
    	            showProjects(projects);
    	        },
    	        error: function (xhr, status, error) {
    	            if (xhr.status === 401) {
    	                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
    	                window.location.href = "index.html";
    	            } else {
    	                console.error("âŒ AJAX ì˜¤ë¥˜ ë°œìƒ:", error);
    	            }
    	        },
    	    });
    	}
      
      function showProjects(projects) {
    	    console.log("í”„ë¡œì íŠ¸ ë°ì´í„°:", projects);  // ë°ì´í„° êµ¬ì¡° í™•ì¸

    	    let projectContainer = $("#projectList");
    	    projectContainer.empty();

    	    if (projects.length > 0) {
    	        projects.forEach(project => {
    	            const projectCode = getProjectCode(project);
    	            projectContainer.append(projectCode);
    	            
    	            $(`#project-${project.id}`).on("click", function() {
    	                goToTeamPage(project.id);
    	            });
    	        });
    	    } else {
    	        projectContainer.append("<p>No On Going Projects</p>");
    	    }

    	}


      // ì¶”ê°€ ì‘ì—… í•„ìš”
     function goToTeamPage(projectId) {
    	$.ajax({
        	url: "jsp/enterteamwindow.jsp",
        	type: "POST",
        	data: { userId: userId, projectId: projectId },
        	success: function(response) {
            	if (response.trim() === "OK") {
                	window.location.href = "TeamPage.html";  // âœ… URLì—ì„œ ID ì œê±° (ì„¸ì…˜ ì‚¬ìš©)
            	} else {
                	alert("ì„¸ì…˜ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            	}
        	},
        	error: function(xhr, status, error) {
            	console.error("ì„¸ì…˜ ì„¤ì • ì˜¤ë¥˜:", error);
        	}
    	});
	}

      function getProjectCode(project) {
        return `
         <div class="project" id="project-${project.id}">
           <h3>${project.name}</h3>
           <p>ğŸ“… Created At: ${project.createdAt}</p>
         </div>
        `;
      }
      
      function clearInputs() {
          $("#projectName").val('');
          $("#projectOwner").val('');
          $("#projectDesc").val('');
        }
      
      $("#addProjectBtn").on("click", function () {
        $("#projectModal").show();
      });

      $(window).on("click", function (event) {
        if ($(event.target).is("#projectModal")) {
          $("#projectModal").hide();
        }
      });

      $("#createProjectBtn").on("click", function () {
        const projectName = $("#projectName").val();
        const projectOwner = $("#projectOwner").val();
		const projectDesc = $("#projectDesc").val();
		
        console.log("í”„ë¡œì íŠ¸ ì†Œìœ ì:", projectOwner);
        
        console.log("í”„ë¡œì íŠ¸ ì„¤ëª…:", projectDesc);
        
        if (projectName && projectOwner && projectDesc) {
          $.ajax({
            url: "jsp/AddProject.jsp",
            type: "POST",
            data: {
              projectName: projectName,
              adminUserID: projectOwner,
              projectDesc: projectDesc
            },
            success: function(response) {
              alert("í”„ë¡œì íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!");
              location.reload();
            },
            error: function(xhr, status, error) {
              console.error("í”„ë¡œì íŠ¸ ì¶”ê°€ ì‹¤íŒ¨:", error);
              alert("í”„ë¡œì íŠ¸ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            }
          });
          $("#projectModal").hide();
          clearInputs();
        } else {
          alert("ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        }
	});


		function loadIssues() {
        	console.log(userId);
            $.ajax({
                url: "jsp/projectIssueListByUser.jsp",
                type: "POST",
                data: { userid: userId },
                dataType: "json",
                success: function (issues) {
                    console.log("âœ… Loaded issues:", issues);
                    displayIssues(issues);
                },
                error: function (xhr, status, error) {
                    console.error("âŒ AJAX ì˜¤ë¥˜ ë°œìƒ:", error);
                }
            });
        }

        function displayIssues(issues) {
            const issueList = $("#issueList");
			console.log("display");
            issueList.empty();

            issues.forEach(issue => {
                issueList.append(getIssues(issue));
            
            	$(`#issue-${issue.issueid}`).on("click", function() {
					$.ajax({
			        	url: "jsp/enterteamwindow.jsp",
			        	type: "POST",
			        	data: { userId: userId, projectId: issue.projectid},
			        	success: function(response) {
			            	if (response.trim() === "OK") {
			                	window.location.href = "IssuePage.html";  // âœ… URLì—ì„œ ID ì œê±° (ì„¸ì…˜ ì‚¬ìš©)
			            	} else {
			                	alert("ì„¸ì…˜ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
			            	}
			        	},
			        	error: function(xhr, status, error) {
			            	console.error("ì„¸ì…˜ ì„¤ì • ì˜¤ë¥˜:", error);
			        	}
			    	});
				});
            });
        }

        function getIssues(issue) {
            return `
            	<div class="issue" id="issue-${issue.issueid}"><span>âš ï¸ ${issue.title}</span></div>
            `;
        }
        
        // ê°„íŠ¸ ì„¤ì •
        gantt.config.lightbox = false; // âœ… lightbox ì™„ì „ ë¹„í™œì„±í™”
        gantt.attachEvent("onTaskDblClick", function (id, e) {
            return false; // âœ… ë”ë¸”í´ë¦­ ì´ë²¤íŠ¸ ë¬´ì‹œ
        });
     	// âœ… Taskë¥¼ ì„ íƒí•  ìˆ˜ ìˆë„ë¡ ê¸°ë³¸ ì„¤ì • ìœ ì§€
        gantt.config.readonly = false; 

        // âœ… Task ì´ë™(Drag & Drop) ì°¨ë‹¨
        gantt.attachEvent("onBeforeTaskDrag", function (id, mode, e) {
            return false; // âœ… ë“œë˜ê·¸ & ë“œë¡­ ì°¨ë‹¨
        });

        // âœ… Task ìˆ˜ì • ì°¨ë‹¨
        gantt.attachEvent("onBeforeTaskChanged", function (id, mode, task) {
            return false; // âœ… ìˆ˜ì • ì°¨ë‹¨
        });

        // âœ… Task ì¶”ê°€ ì°¨ë‹¨
        gantt.attachEvent("onBeforeTaskAdd", function (id, task) {
            return false; // âœ… ìƒˆë¡œìš´ Task ì¶”ê°€ ì°¨ë‹¨
        });

        // âœ… Task ì‚­ì œ ì°¨ë‹¨
        gantt.attachEvent("onBeforeTaskDelete", function (id, task) {
            return false; // âœ… Task ì‚­ì œ ì°¨ë‹¨
        });

        // âœ… Lightbox (ë”ë¸”í´ë¦­ ìˆ˜ì • ì°½) ì°¨ë‹¨
        gantt.attachEvent("onTaskDblClick", function (id, e) {
            return false; // âœ… ë”ë¸”í´ë¦­ ë°©ì§€
        });

        // âœ… ì˜¤ë¥¸ìª½ í´ë¦­ ì‹œ Context ë©”ë‰´ ë°©ì§€
        gantt.attachEvent("onContextMenu", function (taskId, linkId, event) {
            return false; // âœ… ë§ˆìš°ìŠ¤ ìš°í´ë¦­ ë©”ë‰´ ë°©ì§€
        });


		
        loadGanttChart();

    });  
    
    function calculateDuration(startDate, endDate) {
        if (!startDate || !endDate) return 1;
        return Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24));
    }

    
    function loadGanttChart() {
        $.ajax({
            url: "jsp/GetUserProjects.jsp", // âœ… ì‚¬ìš©ì í”„ë¡œì íŠ¸ ë°ì´í„° ìš”ì²­
            type: "GET",
            dataType: "json",
            success: function (projects) {
                console.log("âœ… ì‚¬ìš©ì í”„ë¡œì íŠ¸ ë°ì´í„° ìˆ˜ì‹ :", projects);

                let ganttData = projects.map(project => ({
                    id: project.id,
                    text: project.name,
                    start_date: new Date(project.created_at), // âœ… í”„ë¡œì íŠ¸ ì‹œì‘ ë‚ ì§œ ì‚¬ìš© (YYYY-MM-DD í˜•ì‹)
                    duration: calculateDuration(project.created_at, project.end_date), // âœ… ê¸°ë³¸ 30ì¼ ì„¤ì • (ì¡°ì • ê°€ëŠ¥)
                    open: true
                }));

                gantt.clearAll();
                gantt.parse({ data: ganttData });
            },
            error: function (xhr, status, error) {
                console.error("âŒ í”„ë¡œì íŠ¸ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", error);
            }
        });
    }

    // âœ… Gantt Chartì— í”„ë¡œì íŠ¸ ì¶”ê°€ (ì¡°íšŒ ì „ìš©)
    function addProjectToGantt(project) {
        let ganttData = [{
            id: project.id,
            text: project.name,
            start_date: new Date(project.created_at),
            duration: 30, // ê¸°ë³¸ 30ì¼ ì„¤ì •
            open: true
        }];

        gantt.addTask(ganttData[0]); // âœ… Gantt Chartì— ì¶”ê°€
    }
    
    </script>
  </body>
</html>