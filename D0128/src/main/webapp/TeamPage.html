<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOLE - íŒ€ í˜ì´ì§€</title>
    <link rel="stylesheet" href="css/TeamPage.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

    <!-- ğŸ“Œ ìƒë‹¨ë°” -->
    <div class="header">
        <h1>MOLE</h1>
    </div>

    <div class="container">
        <!-- ğŸ“Œ ì™¼ìª½ ì‚¬ì´ë“œë°” -->
        <div class="sidebar">
            <ul>
                <li class="sidebar-link" data-link="MainPage.html">ëŒ€ì‹œë³´ë“œ</li>
                <li class="sidebar-link" data-link="TeamPage.html">íŒ€ í˜ì´ì§€</li>
                <li class="sidebar-link" data-link="GanttChart.html">ê°„íŠ¸ ì°¨íŠ¸</li>
                <li class="sidebar-link" data-link="IssuePage.html">ì´ìŠˆ</li>
                <li class="sidebar-link" data-link="TeamBoard.html">íŒ€ ë³´ë“œ</li>
            </ul>
        </div>

        <!-- ğŸ“Œ ë©”ì¸ ì½˜í…ì¸  -->
        <div class="main-content">
            <h2>íŒ€ í˜ì´ì§€</h2>
            <p>ì´ê³³ì—ì„œ íŒ€ì„ ê´€ë¦¬í•˜ê³  ì°¸ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

            <!-- ğŸ“Œ ìƒíƒœ ê°œìš” ë° ìµœê·¼ í™œë™ -->
            <div class="overview">
                <div class="status-chart">
                    <h2>ìƒíƒœ ê°œìš”</h2>
                    <p>ì´ìŠˆ í˜„í™©ì„ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”. <a href="#">ëª¨ë“  ì´ìŠˆ ë³´ê¸°</a></p>
                    <canvas id="statusPieChart"></canvas>
                </div>

                <div class="recent-activities">
                    <h2>ìµœê·¼ í™œë™</h2>
                    <p>ì‘ì—… ë³€ê²½ ì‚¬í•­ì´ ì—¬ê¸°ì— ê¸°ë¡ë©ë‹ˆë‹¤.</p>
                    <div class="activity-log" id="activityLog"></div>
                </div>
            </div>

            <!-- ğŸ“Œ í•  ì¼ ê´€ë¦¬ -->
            <div class="tasks-container">
                <div class="task-box" id="todo">
                    <h3>í•  ì¼</h3>
                    <div class="task-list" id="todoList"></div>
                    <button id="addTaskBtn">+ í•  ì¼ ì¶”ê°€</button>
                </div>
                <div class="task-box" id="inProgress">
                    <h3>ì§„í–‰ ì¤‘</h3>
                    <div class="task-list" id="inProgressList"></div>
                </div>
                <div class="task-box" id="completed">
                    <h3>ì™„ë£Œ</h3>
                    <div class="task-list" id="completedList"></div>
                </div>
            </div>
        </div>
    </div>

   <!-- ğŸ“Œ í•  ì¼ ì¶”ê°€ ëª¨ë‹¬ -->
<div id="addTaskModal" class="modal">
    <div class="modal-content">
        <h3>ìƒˆë¡œìš´ í•  ì¼ ì¶”ê°€</h3>
        <input type="text" id="newTaskInput" placeholder="í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš”">

        <!-- âœ… í”„ë¡œì íŠ¸ ID ì…ë ¥ í•„ë“œ ì¶”ê°€ -->
        <input type="number" id="projectIdInput" placeholder="í”„ë¡œì íŠ¸ ID ì…ë ¥">

        <!-- ì‹œì‘ ë‚ ì§œì™€ ì¢…ë£Œ ë‚ ì§œ ì…ë ¥ í•„ë“œ ì¶”ê°€ (í•„ìš”ì‹œ) -->
        <input type="date" id="startDateInput">
        <input type="date" id="endDateInput">

        <button id="saveTaskBtn" class="modal-btn">ì¶”ê°€</button>
        <button class="modal-btn close" id="closeAddTaskModal">ë‹«ê¸°</button>
    </div>
</div>


    <!-- ğŸ“Œ ì‘ì—… ìƒíƒœ ë³€ê²½ ëª¨ë‹¬ -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">ì‘ì—… ìƒíƒœ ë³€ê²½</h3>
            <button id="moveTask" class="modal-btn">ì§„í–‰ ì¤‘ìœ¼ë¡œ ì´ë™</button>
            <button id="deleteTask" class="modal-btn delete">ì‚­ì œ</button>
            <button id="closeModal" class="modal-btn close">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- ğŸ“Œ í”„ë¡œí•„ ë©”ë‰´ -->
    <div class="profile-container">
        <img src="public/logo-transparent.png" alt="MOLE PMS Logo" class="profile-btn" id="profileBtn">
        <div class="profile-menu" id="profileMenu">
            <ul>
                <li data-link="MainPage.html">í™ˆ</li>
                <li data-link="TeamPage.html">íŒ€ í˜ì´ì§€</li>
                <li data-link="FindTeam.html">íŒ€ ì°¾ê¸°</li>
                <li data-link="CreateTeam.html">íŒ€ ë§Œë“¤ê¸°</li>
                <li data-link="TeamManage.html">íŒ€ ê´€ë¦¬</li>
                <li data-link="ProfilePage.html">í”„ë¡œí•„</li>
                <li data-link="SettingsPage.html">ì„¤ì •</li>
            </ul>
        </div>
    </div>

</body>
</html>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // 1. ì‚¬ì´ë“œë°” í´ë¦­ ì‹œ í˜ì´ì§€ ì´ë™
    document.querySelectorAll('.sidebar-link').forEach(link => {
        link.addEventListener('click', function () {
            const targetPage = this.getAttribute('data-link');
            window.location.href = targetPage;
        });
    });

    // 2. í”„ë¡œí•„ ë©”ë‰´ í† ê¸€
    const profileBtn = document.getElementById("profileBtn");
    const profileMenu = document.getElementById("profileMenu");

    profileBtn.addEventListener("click", function (event) {
        event.stopPropagation();
        profileMenu.classList.toggle("active");
    });

    document.addEventListener("click", function (event) {
        if (!profileBtn.contains(event.target) && !profileMenu.contains(event.target)) {
            profileMenu.classList.remove("active");
        }
    });

    document.querySelectorAll('.profile-menu li').forEach(item => {
        item.addEventListener('click', function () {
            const targetPage = this.getAttribute('data-link');
            window.location.href = targetPage;
        });
    });

    // 3. í•  ì¼ ì¶”ê°€ ëª¨ë‹¬ ê´€ë ¨
    const addTaskButton = document.getElementById("addTaskBtn");
    const addTaskModal = document.getElementById("addTaskModal");
    const saveTaskButton = document.getElementById("saveTaskBtn");
    const closeAddTaskModal = document.getElementById("closeAddTaskModal");
    const newTaskInput = document.getElementById("newTaskInput");
    const todoList = document.getElementById("todoList");

    addTaskButton.addEventListener("click", function () {
        addTaskModal.style.display = "block";
        newTaskInput.value = ""; 
    });

    closeAddTaskModal.addEventListener("click", function () {
        addTaskModal.style.display = "none";
    });

    // 4. í•  ì¼ ì €ì¥ (DB ì €ì¥ í¬í•¨)
    saveTaskButton.addEventListener("click", function () {
    const newTaskText = newTaskInput.value.trim();
    const projectId = document.getElementById("projectIdInput").value.trim();
    const startDate = document.getElementById("startDateInput").value;
    const endDate = document.getElementById("endDateInput").value;

    if (newTaskText && projectId) {
        $.ajax({
            url: "jsp/AddTask.jsp",
            type: "POST",
            data: {
                taskName: newTaskText,
                projectId: projectId,
                startDate: startDate,
                endDate: endDate
            },
            success: function (response) {
                const res = JSON.parse(response);
                if (res.success) {
                    const newTask = createTaskItem(newTaskText, res.taskId);  // taskId ë°›ì•„ì˜¤ê¸°
                    todoList.appendChild(newTask);
                    addActivityLog(`ğŸ“ í•  ì¼ ì¶”ê°€ë¨: ${newTaskText}`);
                    updateChart();
                    addTaskModal.style.display = "none";
                } else {
                    alert("í•  ì¼ ì¶”ê°€ ì‹¤íŒ¨: " + res.error);
                }
            },
            error: function () {
                alert("ì„œë²„ ì˜¤ë¥˜ ë°œìƒ");
            }
        });
    } else {
        alert("í•  ì¼ê³¼ í”„ë¡œì íŠ¸ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”!");
    }
});


    // 5. DBì—ì„œ í•  ì¼ ë¶ˆëŸ¬ì˜¤ê¸°
    function loadTasks() {
        $.ajax({
            url: "jsp/GetTasks.jsp",
            type: "GET",
            dataType: "json",
            success: function(tasks) {
                displayTasks(tasks);  
                updateChart(tasks);   
            },
            error: function() {
                alert("í•  ì¼ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
            }
        });
    }

    // 6. í•  ì¼ ëª©ë¡ í‘œì‹œ
    function displayTasks(tasks) {
        $("#todoList").empty();
        $("#inProgressList").empty();
        $("#completedList").empty();

        tasks.forEach(task => {
            const taskElement = createTaskItem(task.name, task.id);
            $("#todoList").append(taskElement);  // ê¸°ë³¸ì ìœ¼ë¡œ 'í•  ì¼'ì— ì¶”ê°€ (ìƒíƒœì— ë”°ë¼ ë³€ê²½ ê°€ëŠ¥)
        });
    }

    // 7. ì›í˜• ê·¸ë˜í”„ ì—…ë°ì´íŠ¸
    function updateChart(tasks) {
        const todoCount = tasks.length;  // ì „ì²´ í•  ì¼ ê°œìˆ˜
        const inProgressCount = 0;       // ì§„í–‰ ì¤‘ í•  ì¼ ê°œìˆ˜ (ì¶”ê°€ êµ¬í˜„ ê°€ëŠ¥)
        const completedCount = 0;        // ì™„ë£Œëœ í•  ì¼ ê°œìˆ˜ (ì¶”ê°€ êµ¬í˜„ ê°€ëŠ¥)

        const ctx = document.getElementById("statusPieChart").getContext("2d");
        const statusPieChart = new Chart(ctx, {
            type: "doughnut",
            data: {
                labels: ["í•  ì¼", "ì§„í–‰ ì¤‘", "ì™„ë£Œ"],
                datasets: [{
                    data: [todoCount, inProgressCount, completedCount],
                    backgroundColor: ["#FF6384", "#FFD700", "#4CAF50"],
                }]
            }
        });
    }

    // 8. í•  ì¼ í´ë¦­ ì‹œ ì‘ì—… ìƒíƒœ ë³€ê²½ ëª¨ë‹¬ ì—´ê¸°
    function createTaskItem(text, taskId) {
        const task = document.createElement("div");
        task.classList.add("task-item");
        task.textContent = text;

        task.addEventListener("click", function () {
            openTaskModal(task, text, taskId);
        });

        return task;
    }

    // 9. ì‘ì—… ìƒíƒœ ë³€ê²½ ëª¨ë‹¬
    const taskModal = document.getElementById("taskModal");
    const modalTitle = document.getElementById("modalTitle");
    const moveButton = document.getElementById("moveTask");
    const deleteButton = document.getElementById("deleteTask");
    const closeButton = document.getElementById("closeModal");
    const inProgressList = document.getElementById("inProgressList");
    const completedList = document.getElementById("completedList");

    function openTaskModal(task, text, taskId) {
        taskModal.style.display = "block";
        modalTitle.textContent = `ì‘ì—…: ${text}`;

        const parentList = task.parentElement;

        if (parentList.id === "todoList") {
            moveButton.textContent = "ì§„í–‰ ì¤‘ìœ¼ë¡œ ì´ë™";
            moveButton.onclick = () => moveTask(task, inProgressList, "â³ ì§„í–‰ ì¤‘", taskId);
        } else if (parentList.id === "inProgressList") {
            moveButton.textContent = "ì™„ë£Œë¡œ ì´ë™";
            moveButton.onclick = () => moveTask(task, completedList, "âœ… ì™„ë£Œë¨", taskId);
        } else {
            moveButton.style.display = "none";
        }

        deleteButton.onclick = () => {
            deleteTask(taskId);  // DBì—ì„œ ì‚­ì œ
            task.remove();
            addActivityLog(`âŒ ì‚­ì œë¨: ${text}`);
            updateChart([]);
            closeModal();
        };
    }

    moveButton.addEventListener("click", function () {
        closeModal();
    });

    closeButton.addEventListener("click", function () {
        closeModal();
    });

    function closeModal() {
        taskModal.style.display = "none";
    }

    // 10. ì‘ì—… ì´ë™ (DB ìƒíƒœ ì—…ë°ì´íŠ¸)
    function moveTask(task, targetList, message, taskId) {
        targetList.appendChild(task);
        addActivityLog(`${message}: ${task.textContent}`);
        updateTaskStatus(taskId, message);  // DB ìƒíƒœ ì—…ë°ì´íŠ¸
        updateChart([]);
        closeModal();
    }

    // 11. DBì—ì„œ ì‘ì—… ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateTaskStatus(taskId, status) {
        $.ajax({
            url: "jsp/UpdateTaskStatus.jsp",
            type: "POST",
            data: {
                taskId: taskId,
                status: status
            },
            success: function(response) {
                const res = JSON.parse(response);
                if (!res.success) {
                    alert("ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: " + res.error);
                }
            },
            error: function() {
                alert("ì„œë²„ ì˜¤ë¥˜ ë°œìƒ");
            }
        });
    }

    // 12. DBì—ì„œ ì‘ì—… ì‚­ì œ
    function deleteTask(taskId) {
        $.ajax({
            url: "jsp/DeleteTask.jsp",
            type: "POST",
            data: { taskId: taskId },
            success: function(response) {
                const res = JSON.parse(response);
                if (!res.success) {
                    alert("ì‚­ì œ ì‹¤íŒ¨: " + res.error);
                }
            },
            error: function() {
                alert("ì„œë²„ ì˜¤ë¥˜ ë°œìƒ");
            }
        });
    }

    // 13. í™œë™ ë¡œê·¸ ì¶”ê°€
    function addActivityLog(message) {
        const logContainer = document.getElementById("activityLog");
        const time = new Date().toLocaleString();
        const log = document.createElement("p");
        log.textContent = `[${time}] ${message}`;
        logContainer.prepend(log);
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ í•  ì¼ ë¶ˆëŸ¬ì˜¤ê¸°
    loadTasks();
});
</script>
