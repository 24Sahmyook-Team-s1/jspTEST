<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOLE - íŒ€ í˜ì´ì§€</title>
    <link rel="stylesheet" href="css/TeamPage.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

    <!-- ìƒë‹¨ë°” -->
    <div class="header">
        <h1>MOLE</h1>
    </div>

    <div class="container">
        <!-- ì™¼ìª½ ì‚¬ì´ë“œë°” -->
        <div class="sidebar">
            <ul>
                <li class="sidebar-link" data-link="MainPage.html">ëŒ€ì‹œë³´ë“œ</li>
                <li class="sidebar-link" data-link="TeamPage.html">íŒ€ í˜ì´ì§€</li>
                <li class="sidebar-link" data-link="GanttChart.html">ê°„íŠ¸ ì°¨íŠ¸</li>
                <li class="sidebar-link" data-link="IssuePage.html">ì´ìŠˆ</li>
                <li class="sidebar-link" data-link="TeamBoard.html">íŒ€ ë³´ë“œ</li>
            </ul>
        </div>

        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <div class="main-content">
            <h2>íŒ€ í˜ì´ì§€</h2>
            <p>ì´ê³³ì—ì„œ íŒ€ì„ ê´€ë¦¬í•˜ê³  ì°¸ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

            <!-- ìƒíƒœ ê°œìš” ë° ìµœê·¼ í™œë™ -->
            <div class="overview">
                <div class="status-chart">
                    <h2>ìƒíƒœ ê°œìš”</h2>
                    <p>ì´ìŠˆ í˜„í™©ì„ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”. <a href="#">ëª¨ë“  ì´ìŠˆ ë³´ê¸°</a></p>
                    <canvas id="statusPieChart"></canvas>
                </div>

                <div class="recent-activities">
                    <h2>ìµœê·¼ í™œë™</h2>
                    <p>ì‘ì—… ë³€ê²½ ì‚¬í•­ì´ ì—¬ê¸°ì— ê¸°ë¡ë©ë‹ˆë‹¤.</p>
                    <div class="activity-log" id="activityLog"></div>
                </div>
            </div>

            <!-- í•  ì¼ ê´€ë¦¬ -->
            <div class="tasks-container">
                <div class="task-box" id="todo">
                    <h3>í•  ì¼</h3>
                    <div class="task-list" id="todoList"></div>
                    <button id="addTaskBtn">+ í•  ì¼ ì¶”ê°€</button>
                </div>
                <div class="task-box" id="inProgress">
                    <h3>ì§„í–‰ ì¤‘</h3>
                    <div class="task-list" id="inProgressList"></div>
                </div>
                <div class="task-box" id="completed">
                    <h3>ì™„ë£Œ</h3>
                    <div class="task-list" id="completedList"></div>
                </div>
            </div>
        </div>
    </div>
    
     <div class="profile-container">
      <img src="public/logo-transparent.png" alt="MOLE PMS Logo" class="profile-btn" id="profileBtn">
      <div class="profile-menu" id="profileMenu">
        <ul>
          <li data-link="MainPage.html">í™ˆ</li>
          <li data-link="TeamPage.html">íŒ€ í˜ì´ì§€</li>
          <li data-link="FindTeam.html">íŒ€ ì°¾ê¸°</li>
          <li data-link="CreateTeam.html">íŒ€ ë§Œë“¤ê¸°</li>
          <li data-link="TeamManage.html">íŒ€ ê´€ë¦¬</li>
          <li data-link="ProfilePage.html">í”„ë¡œí•„</li>
          <li data-link="SettingsPage.html">ì„¤ì •</li>
        </ul>
      </div>
    </div>

    <!-- í•  ì¼ ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="addTaskModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>ìƒˆë¡œìš´ í•  ì¼ ì¶”ê°€</h3>
            <input type="text" id="newTaskInput" placeholder="í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš”">
            <input type="date" id="startDateInput" placeholder="ì‹œì‘ì¼">
            <input type="date" id="endDateInput" placeholder="ì¢…ë£Œì¼">
            <input type="number" id="projectIdInput" placeholder="í”„ë¡œì íŠ¸ ID">
            <button id="saveTaskBtn" class="modal-btn">ì¶”ê°€</button>
            <button class="modal-btn close" id="closeAddTaskModal">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- ì‘ì—… ìƒíƒœ ë³€ê²½ ëª¨ë‹¬ -->
    <div id="taskModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3 id="modalTitle">ì‘ì—… ìƒíƒœ ë³€ê²½</h3>
            <button id="moveTask" class="modal-btn">ì§„í–‰ ì¤‘ìœ¼ë¡œ ì´ë™</button>
            <button id="completeTask" class="modal-btn">ì™„ë£Œë¡œ ì´ë™</button>
            <button id="deleteTask" class="modal-btn delete">ì‚­ì œ</button>
            <button class="modal-btn close" id="closeModal">ë‹«ê¸°</button>
        </div>
    </div>

<script>
$(document).ready(function () {
	const urlParams = new URLSearchParams(window.location.search);
    const projectId = urlParams.get('projectid');
    let userId;
    
    $.ajax({
        url: "jsp/session.jsp",
        type: "GET",
        success: function(response) {
            if (response.includes("ë¡œê·¸ì¸í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")) {
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                window.location.href = "index.html"; // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
            }
            else{
            	userId = response; // ì„¸ì…˜ì—ì„œ ì‚¬ìš©ì IDë¥¼ ê°€ì ¸ì˜¤ëŠ” ë¶€ë¶„
            	console.log("ìœ ì € id: " + userId);
                console.log("í”„ë¡œì íŠ¸ id: " + projectId);
                loadTasks(userId, projectId); // í˜ì´ì§€ ë¡œë“œ ì‹œ í•  ì¼ ë¶ˆëŸ¬ì˜¤ê¸°
                console.log("í˜ì´ì§€ ë¡œë“œ + ìœ ì € id, í”„ë¡œì íŠ¸ id ì™„ë£Œ");
            }
        },
        error: function(xhr, status, error) {
            console.error("ì„¸ì…˜ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        }
    });
	
    // ğŸ“Œ ì‚¬ì´ë“œë°” ë° í”„ë¡œí•„ ë©”ë‰´ í´ë¦­ ì‹œ í˜ì´ì§€ ì´ë™
    $(".sidebar-link, .profile-menu li").on("click", function () {
        const targetPage = $(this).data("link");
        window.location.href = targetPage;
    });

    // ğŸ“Œ í”„ë¡œí•„ ë²„íŠ¼ í´ë¦­ ì‹œ ë©”ë‰´ í† ê¸€
    const profileBtn = $("#profileBtn");
    const profileMenu = $("#profileMenu");

    profileBtn.on("click", function (event) {
        event.stopPropagation();
        profileMenu.toggleClass("active");
    });

    $(document).on("click", function (event) {
        if (!profileBtn.is(event.target) && !profileMenu.is(event.target) && profileMenu.has(event.target).length === 0) {
            profileMenu.removeClass("active");
        }
    });
    
    // í•  ì¼ ì¶”ê°€ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    $("#addTaskBtn").on("click", function () {
        console.log("í•  ì¼ ì¶”ê°€ ë²„íŠ¼ í´ë¦­ë¨");
        $("#addTaskModal").show();  // ëª¨ë‹¬ ì°½ í‘œì‹œ
    });

    // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
    $("#closeAddTaskModal, #closeModal").on("click", function () {
        console.log("ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ í´ë¦­ë¨");
        $(".modal").hide();
    });

    // í•  ì¼ ì €ì¥ (DBì— ì €ì¥)
    $("#saveTaskBtn").on("click", function () {
        console.log("í•  ì¼ ì €ì¥ ë²„íŠ¼ í´ë¦­ë¨");

        const taskName = $("#newTaskInput").val().trim();
        const startDate = $("#startDateInput").val();
        const endDate = $("#endDateInput").val();
        const projectId = $("#projectIdInput").val();

        if (taskName && startDate && endDate && projectId) {
            console.log("ëª¨ë“  ì…ë ¥ ê°’ í™•ì¸:", taskName, startDate, endDate, projectId);

            $.ajax({
                url: "jsp/AddTask.jsp",
                type: "POST",
                data: { taskName, startDate, endDate, projectId },
                dataType: "json",
                success: function (response) {
                    console.log("AddTask.jsp ì‘ë‹µ:", response);

                    if (response.success) {
                        alert("í•  ì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!");
                        addActivityLog(`í•  ì¼ ì¶”ê°€ë¨: ${taskName}`);
                        loadTasks();  // í•  ì¼ ì¶”ê°€ í›„ ëª©ë¡ ë° ì°¨íŠ¸ ê°±ì‹ 
                        $("#addTaskModal").hide();
                    } else {
                        alert("í•  ì¼ ì¶”ê°€ ì‹¤íŒ¨: " + response.error);
                    }
                },
                error: function (xhr, status, error) {
                    console.error("í•  ì¼ ì¶”ê°€ AJAX ì˜¤ë¥˜:", status, error);
                }
            });
        } else {
            alert("ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        }
    });

    // í•  ì¼ ëª©ë¡ ë¡œë“œ ë° ì°¨íŠ¸ ê°±ì‹ 
    function loadTasks() {
        console.log("í•  ì¼ ëª©ë¡ ë¡œë“œ ì¤‘...");

        $.ajax({
            url: "jsp/GetTasks.jsp",
            type: "GET",
            dataType: "json",
            success: function (tasks) {
                console.log("GetTasks.jsp ì‘ë‹µ:", tasks);
                displayTasks(tasks);  // í•  ì¼ ëª©ë¡ í™”ë©´ í‘œì‹œ
                updateChart(tasks);  // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            },
            error: function () {
                console.error("í•  ì¼ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
            }
        });
    }

    // í•  ì¼ í™”ë©´ì— í‘œì‹œ
    function displayTasks(tasks) {
        $("#todoList, #inProgressList, #completedList").empty();  // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”

        tasks.forEach(task => {
            const taskElement = $(`<div class="task-item" data-id="${task.scheduleId}">${task.taskName}</div>`);

            taskElement.on("click", function () {
                openTaskModal(task);  // ì‘ì—… í´ë¦­ ì‹œ ìƒíƒœ ë³€ê²½ ëª¨ë‹¬ ì—´ê¸°
            });

            // ì‘ì—… ìƒíƒœì— ë”°ë¼ ëª©ë¡ì— ì¶”ê°€
            if (task.status === "todo") {
                $("#todoList").append(taskElement);
            } else if (task.status === "inProgress") {
                $("#inProgressList").append(taskElement);
            } else if (task.status === "completed") {
                $("#completedList").append(taskElement);
            }
        });
    }

    // ì‘ì—… ìƒíƒœ ë³€ê²½ ëª¨ë‹¬ ì—´ê¸°
    function openTaskModal(task) {
        $("#modalTitle").text(`ì‘ì—…: ${task.taskName}`);
        $("#taskModal").show();

        // ìƒíƒœ ì´ë™ ë²„íŠ¼ ì´ë²¤íŠ¸
        $("#moveTask").off().on("click", function () {
            updateTaskStatus(task.scheduleId, "inProgress");
        });

        $("#completeTask").off().on("click", function () {
            updateTaskStatus(task.scheduleId, "completed");
        });

        $("#deleteTask").off().on("click", function () {
            deleteTask(task.scheduleId);
        });
    }

    // ì‘ì—… ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateTaskStatus(scheduleId, newStatus) {
        $.ajax({
            url: "jsp/UpdateTaskStatus.jsp",
            type: "POST",
            data: { scheduleId, status: newStatus },
            success: function (response) {
                console.log("UpdateTaskStatus.jsp ì‘ë‹µ:", response);
                alert("ì‘ì—… ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
                addActivityLog(`ì‘ì—… ìƒíƒœ ë³€ê²½ë¨: ${getTaskNameById(scheduleId)} â†’ ${newStatus}`);
                loadTasks();
                $("#taskModal").hide();
            },
            error: function () {
                alert("ì‘ì—… ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨");
            }
        });
    }

    // ì‘ì—… ì‚­ì œ
    function deleteTask(scheduleId) {
        $.ajax({
            url: "jsp/DeleteTask.jsp",
            type: "POST",
            data: { scheduleId },
            success: function () {
                alert("ì‘ì—…ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                addActivityLog(`ì‘ì—… ì‚­ì œë¨: ${getTaskNameById(scheduleId)}`);
                loadTasks();
                $("#taskModal").hide();
            },
            error: function () {
                alert("ì‘ì—… ì‚­ì œ ì‹¤íŒ¨");
            }
        });
    }

    // ì›í˜• ê·¸ë˜í”„ ì—…ë°ì´íŠ¸
    function updateChart(tasks) {
        const todoCount = tasks.filter(task => task.status.toLowerCase() === "todo").length;
        const inProgressCount = tasks.filter(task => task.status.toLowerCase() === "inprogress").length;
        const completedCount = tasks.filter(task => task.status.toLowerCase() === "completed").length;

        console.log(`ì°¨íŠ¸ ë°ì´í„° - í•  ì¼: ${todoCount}, ì§„í–‰ ì¤‘: ${inProgressCount}, ì™„ë£Œ: ${completedCount}`);

        const ctx = document.getElementById("statusPieChart").getContext("2d");

        // ì°¨íŠ¸ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ í›„ destroy í˜¸ì¶œ
        if (window.statusPieChart && typeof window.statusPieChart.destroy === 'function') {
            window.statusPieChart.destroy();
        }

        // ìƒˆ ì°¨íŠ¸ ìƒì„±
        window.statusPieChart = new Chart(ctx, {
            type: "doughnut",
            data: {
                labels: ["í•  ì¼", "ì§„í–‰ ì¤‘", "ì™„ë£Œ"],
                datasets: [{
                    data: [todoCount, inProgressCount, completedCount],
                    backgroundColor: ["#FF6384", "#FFD700", "#4CAF50"],
                    borderColor: "#ffffff",
                    borderWidth: 2
                }]
            },
            options: {
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                cutout: '70%'  // ë„ë„› í˜•íƒœë¥¼ ìœ„í•œ ì„¤ì •
            }
        });
    }

    // ìµœê·¼ í™œë™ ë¡œê·¸ ì¶”ê°€
    function addActivityLog(message) {
        const currentTime = new Date().toLocaleString();
        const logEntry = `<p>[${currentTime}] ${message}</p>`;
        $("#activityLog").prepend(logEntry);
    }

    // ì‘ì—… IDë¡œ ì‘ì—… ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
    function getTaskNameById(scheduleId) {
        const taskElement = $(`.task-item[data-id="${scheduleId}"]`);
        return taskElement.text().trim();
    }
});
</script>

</body>
</html>