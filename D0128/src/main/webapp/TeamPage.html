<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOLE - íŒ€ í˜ì´ì§€</title>
    <link rel="stylesheet" href="css/TeamPage.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/jquery-3.6.0.min.js"></script>
</head>
<body>

    <!-- ìƒë‹¨ë°” -->
    <div class="header">
        <h1>MOLE</h1>
    </div>

    <div class="container">
        <!-- ì™¼ìª½ ì‚¬ì´ë“œë°” -->
        <div class="sidebar">
            <ul>
                <li class="sidebar-link" data-link="MainPage.html">ëŒ€ì‹œë³´ë“œ</li>
                <li class="sidebar-link" data-link="TeamPage.html">íŒ€ í˜ì´ì§€</li>
                <li class="sidebar-link" data-link="GanttChart.html">ê°„íŠ¸ ì°¨íŠ¸</li>
                <li class="sidebar-link" data-link="IssuePage.html">ì´ìŠˆ</li>
                <li class="sidebar-link" data-link="TeamBoard.html">íŒ€ ë³´ë“œ</li>
            </ul>
        </div>

        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <div class="main-content">
            <h2>íŒ€ í˜ì´ì§€</h2>
            <p>ì´ê³³ì—ì„œ íŒ€ì„ ê´€ë¦¬í•˜ê³  ì°¸ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

            <!-- ìƒíƒœ ê°œìš” ë° ìµœê·¼ í™œë™ -->
            <div class="overview">
                <div class="status-chart">
                    <h2>ìƒíƒœ ê°œìš”</h2>
                    <p>ì´ìŠˆ í˜„í™©ì„ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”. <a href="#">ëª¨ë“  ì´ìŠˆ ë³´ê¸°</a></p>
                    <canvas id="statusPieChart"></canvas>
                </div>

                <div class="recent-activities">
                    <h2>ìµœê·¼ í™œë™</h2>
                    <p>ì‘ì—… ë³€ê²½ ì‚¬í•­ì´ ì—¬ê¸°ì— ê¸°ë¡ë©ë‹ˆë‹¤.</p>
                    <div class="activity-log" id="activityLog"></div>
                </div>
            </div>

            <!-- í•  ì¼ ê´€ë¦¬ -->
            <div class="tasks-container">
                <div class="task-box" id="todo">
                    <h3>í•  ì¼</h3>
                    <div class="task-list" id="todoList"></div>
                    <button id="addTaskBtn">+ í•  ì¼ ì¶”ê°€</button>
                </div>
                <div class="task-box" id="inProgress">
                    <h3>ì§„í–‰ ì¤‘</h3>
                    <div class="task-list" id="inProgressList"></div>
                </div>
                <div class="task-box" id="completed">
                    <h3>ì™„ë£Œ</h3>
                    <div class="task-list" id="completedList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- í•  ì¼ ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="addTaskModal" class="modal">
        <div class="modal-content">
            <h3>ìƒˆë¡œìš´ í•  ì¼ ì¶”ê°€</h3>
            <input type="text" id="newTaskInput" placeholder="í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš”">
            <input type="date" id="startDateInput" placeholder="ì‹œì‘ì¼">
            <input type="date" id="endDateInput" placeholder="ì¢…ë£Œì¼">
            <input type="number" id="projectIdInput" placeholder="í”„ë¡œì íŠ¸ ID">
            <button id="saveTaskBtn" class="modal-btn">ì¶”ê°€</button>
            <button class="modal-btn close" id="closeAddTaskModal">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- ì‘ì—… ìƒíƒœ ë³€ê²½ ëª¨ë‹¬ -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">ì‘ì—… ìƒíƒœ ë³€ê²½</h3>
            <button id="moveTask" class="modal-btn">ì§„í–‰ ì¤‘ìœ¼ë¡œ ì´ë™</button>
            <button id="deleteTask" class="modal-btn delete">ì‚­ì œ</button>
            <button id="closeModal" class="modal-btn close">ë‹«ê¸°</button>
        </div>
    </div>

</body>
</html>

<script>
$(document).ready(function () {
    let tasks = []; // í•  ì¼ ëª©ë¡ ìƒíƒœ ê´€ë¦¬

    loadTasks(); // í˜ì´ì§€ ë¡œë“œ ì‹œ í•  ì¼ ë¶ˆëŸ¬ì˜¤ê¸°

    // í•  ì¼ ëª©ë¡ ë¡œë“œ (DBì—ì„œ ê°€ì ¸ì˜¤ê¸°)
    function loadTasks() {
        $.ajax({
            url: "jsp/GetTasks.jsp",
            type: "GET",
            dataType: "json",
            success: function (data) {
                tasks = data;         // DBì—ì„œ ê°€ì ¸ì˜¨ ë°ì´í„°ë¥¼ tasks ë°°ì—´ì— ì €ì¥
                displayTasks();       // í™”ë©´ì— í•  ì¼ í‘œì‹œ
                updateChart();        // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            },
            error: function () {
                console.error("í•  ì¼ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
            }
        });
    }

    // í•  ì¼ì„ í™”ë©´ì— í‘œì‹œ
    function displayTasks() {
        $("#todoList, #inProgressList, #completedList").empty();

        tasks.forEach(task => {
            const taskElement = $(`<div class="task-item" data-id="${task.scheduleId}">${task.taskName}</div>`);

            // ì‘ì—… í´ë¦­ ì‹œ ìƒíƒœ ë³€ê²½ ëª¨ë‹¬ ì—´ê¸°
            taskElement.on("click", function () {
                openTaskModal(task);
            });

            // ìƒíƒœì— ë”°ë¼ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
            if (task.status === "todo") {
                $("#todoList").append(taskElement);
            } else if (task.status === "inProgress") {
                $("#inProgressList").append(taskElement);
            } else if (task.status === "completed") {
                $("#completedList").append(taskElement);
            }
        });

        updateChart(); // ìƒíƒœ í‘œì‹œ í›„ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
    }

    // ì‘ì—… ìƒíƒœ ë³€ê²½ ëª¨ë‹¬
    function openTaskModal(task) {
        $("#modalTitle").text(`ì‘ì—…: ${task.taskName}`);
        $("#taskModal").show();

        // ìƒíƒœ ë³€ê²½ ë²„íŠ¼ í´ë¦­ ì‹œ
        $("#moveTask").off().on("click", function () {
            if (task.status === "todo") {
                task.status = "inProgress";
            } else if (task.status === "inProgress") {
                task.status = "completed";
            }

            addActivityLog(`ğŸ”„ ìƒíƒœ ë³€ê²½ë¨: ${task.taskName} â†’ ${task.status === "inProgress" ? "ì§„í–‰ ì¤‘" : "ì™„ë£Œ"}`);
            displayTasks();  // ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
            updateChart();   // ì°¨íŠ¸ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
            $("#taskModal").hide();
        });

        // ì‘ì—… ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ
        $("#deleteTask").off().on("click", function () {
            $.ajax({
                url: "jsp/DeleteTask.jsp",
                type: "POST",
                data: { scheduleId: task.scheduleId },
                success: function (response) {
                    if (response.success) {
                        addActivityLog(`âŒ ì‚­ì œë¨: ${task.taskName}`);
                        loadTasks();  // ì‚­ì œ í›„ ë‹¤ì‹œ ë¡œë“œ
                        $("#taskModal").hide();
                    } else {
                        alert("ì‘ì—… ì‚­ì œ ì‹¤íŒ¨: " + response.error);
                    }
                },
                error: function () {
                    alert("ì‘ì—… ì‚­ì œ ì‹¤íŒ¨.");
                }
            });
        });
    }

    // ì›í˜• ì°¨íŠ¸ ì—…ë°ì´íŠ¸
    function updateChart() {
        const todoCount = tasks.filter(task => task.status === "todo").length;
        const inProgressCount = tasks.filter(task => task.status === "inProgress").length;
        const completedCount = tasks.filter(task => task.status === "completed").length;

        const ctx = document.getElementById("statusPieChart").getContext("2d");

        // ì°¨íŠ¸ ì¤‘ë³µ ìƒì„±ì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ì´ì „ ì°¨íŠ¸ ì œê±°
        if (window.statusPieChart) {
            window.statusPieChart.destroy();
        }

        window.statusPieChart = new Chart(ctx, {
            type: "doughnut",
            data: {
                labels: ["í•  ì¼", "ì§„í–‰ ì¤‘", "ì™„ë£Œ"],
                datasets: [{
                    data: [todoCount, inProgressCount, completedCount],
                    backgroundColor: ["#FF6384", "#FFD700", "#4CAF50"]
                }]
            }
        });
    }

    // ìµœê·¼ í™œë™ ë¡œê·¸ ì¶”ê°€
    function addActivityLog(message) {
        const time = new Date().toLocaleString();
        const logEntry = `<p>[${time}] ${message}</p>`;
        $("#activityLog").prepend(logEntry);
    }

    // ëª¨ë‹¬ ë‹«ê¸°
    $("#closeAddTaskModal, #closeModal").on("click", function () {
        $(".modal").hide();
    });
});

</script>
