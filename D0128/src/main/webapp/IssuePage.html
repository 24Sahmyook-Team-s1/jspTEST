<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOLE - ì´ìŠˆ ê´€ë¦¬</title>
    <link rel="stylesheet" href="css/IssuePage.css">
    <script src="js/jquery-3.6.0.min.js"></script>
    <script src="js/core.js"></script>
</head>
<body>

    <!-- ìƒë‹¨ë°” -->
    <div class="header">
        <h2>MOLE</h2>
    </div>

    <div class="container">
        <!-- ì™¼ìª½ ì‚¬ì´ë“œë°” -->
        <div class="sidebar">
            <ul>
                <li class="sidebar-link" data-link="MainPage.html">ëŒ€ì‹œë³´ë“œ</li>
                <li class="sidebar-link" data-link="TeamPage.html">íŒ€ í˜ì´ì§€</li>
                <li class="sidebar-link" data-link="GanttChart.html">ê°„íŠ¸ ì°¨íŠ¸</li>
                <li class="sidebar-link" data-link="IssuePage.html">ì´ìŠˆ</li>
                <li class="sidebar-link" data-link="TeamBoard.html">íŒ€ ë³´ë“œ</li>
            </ul>
        </div>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <div class="main-content">
            <h1>
                <span>ìœ„í—˜ ê´€ë¦¬</span>
                <div class="issue-buttons">
                    <button class="add-btn">ì´ìŠˆ ì¶”ê°€</button>
                    <button class="delete-btn" data-link="jsp/projectIssueDelete.jsp">ì´ìŠˆ ì‚­ì œ</button>
                    <button class="update-btn">ì´ìŠˆ ì—…ë°ì´íŠ¸</button>
                </div>
            </h1>

            <div class="issue-container">
                <!-- HAZARD -->
                <div class="issue-column hazard">
                    <h2>HAZARD âš ï¸</h2>
                    <div class="issue-header">
                        <span>Name</span>
                        <span>Issue Description</span>
                    </div>
                    <div class="issue-list" id="hazardList"></div>
                </div>

                <!-- ISSUE -->
                <div class="issue-column issue">
                    <h2>ISSUE âš ï¸</h2>
                    <div class="issue-header">
                        <span>Name</span>
                        <span>Issue Description</span>
                    </div>
                    <div class="issue-list" id="issueList"></div>
                </div>

                <!-- SOLVED -->
                <div class="issue-column solved">
                    <h2>SOLVED ğŸŸ¢</h2>
                    <div class="issue-header">
                        <span>Name</span>
                        <span>Issue Description</span>
                    </div>
                    <div class="issue-list" id="solvedList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- í”„ë¡œí•„ ë©”ë‰´ -->
    <div class="profile-container">
        <img src="public/logo-transparent.png" alt="MOLE PMS Logo" class="profile-btn" id="profileBtn">
        <div class="profile-menu" id="profileMenu">
            <ul>
                <li data-link="MainPage.html">í™ˆ</li>
                <li data-link="TeamPage.html">íŒ€ í˜ì´ì§€</li>
                <li data-link="FindTeam.html">íŒ€ ì°¾ê¸°</li>
                <li data-link="CreateTeam.html">íŒ€ ë§Œë“¤ê¸°</li>
                <li data-link="TeamManage.html">íŒ€ ê´€ë¦¬</li>
                <li data-link="ProfilePage.html">í”„ë¡œí•„</li>
                <li data-link="SettingsPage.html">ì„¤ì •</li>
            </ul>
        </div>
    </div>

    <!-- ì´ìŠˆ ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ ëª¨ë‹¬ ì°½ -->
    <div id="issueModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">ì´ìŠˆ ê´€ë¦¬</h2>

            <label for="issueTitle">ì´ìŠˆ ì œëª©</label>
            <input type="text" id="issueTitle" placeholder="ì´ìŠˆ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">

            <label for="issueDescription">ì´ìŠˆ ì„¤ëª…</label>
            <input type="text" id="issueDescription" placeholder="ì´ìŠˆ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">

            <label for="issueLevel">ì´ìŠˆ ë ˆë²¨</label>
            <select id="issueLevel">
                <option value="0">HAZARD âš ï¸</option>
                <option value="1">ISSUE âš ï¸</option>
                <option value="2">SOLVED ğŸŸ¢</option>
            </select>

            <button id="saveIssueBtn" class="add-btn">ì´ìŠˆ ì €ì¥</button>
            <button id="closeModalBtn" class="close">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.addEventListener('click', function () {
                    const targetPage = this.getAttribute('data-link');
                    window.location.href = targetPage;
                });
            });
        });

        // í”„ë¡œí•„ ë©”ë‰´ í† ê¸€
        const profileBtn = document.getElementById("profileBtn");
        const profileMenu = document.getElementById("profileMenu");

        profileBtn.addEventListener("click", function (event) {
            event.stopPropagation();
            profileMenu.classList.toggle("active");
        });

        document.addEventListener("click", function (event) {
            if (!profileBtn.contains(event.target) && !profileMenu.contains(event.target)) {
                profileMenu.classList.remove("active");
            }
        });

        document.querySelectorAll('.profile-menu li').forEach(item => {
            item.addEventListener('click', function () {
                const targetPage = this.getAttribute('data-link');
                window.location.href = targetPage;
            });
        });

        // ëª¨ë‹¬ ê´€ë ¨ ìŠ¤í¬ë¦½íŠ¸
        const issueModal = document.getElementById("issueModal");
        const modalTitle = document.getElementById("modalTitle");
        const saveIssueBtn = document.getElementById("saveIssueBtn");

        document.querySelector('.add-btn').addEventListener('click', function () {
            modalTitle.textContent = "ì´ìŠˆ ì¶”ê°€";
            saveIssueBtn.textContent = "ì´ìŠˆ ì¶”ê°€";
            issueModal.style.display = "flex";
        });

        document.querySelector('.update-btn').addEventListener('click', function () {
            modalTitle.textContent = "ì´ìŠˆ ì—…ë°ì´íŠ¸";
            saveIssueBtn.textContent = "ì—…ë°ì´íŠ¸ ì €ì¥";
            issueModal.style.display = "flex";
        });

        document.getElementById("closeModalBtn").addEventListener('click', function () {
            issueModal.style.display = "none";
        });

        window.addEventListener('click', function (event) {
            if (event.target === issueModal) {
                issueModal.style.display = "none";
            }
        });

        saveIssueBtn.addEventListener('click', function () {
            const issueTitle = document.getElementById("issueTitle").value;
            const issueDescription = document.getElementById("issueDescription").value;
            const issueLevel = document.getElementById("issueLevel").value;

            if (!issueTitle || !issueDescription) {
                alert("ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                return;
            }

            $.ajax({
                url: "jsp/projectIssueAdd.jsp",
                type: "POST",
                data: {
                    title: issueTitle,
                    description: issueDescription,
                    level: issueLevel
                },
                success: function (response) {
                    alert("ì´ìŠˆê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    issueModal.style.display = "none";
                    loadIssues();
                },
                error: function (xhr, status, error) {
                    console.error("ì´ìŠˆ ì¶”ê°€ ì‹¤íŒ¨:", error);
                    alert("ì´ìŠˆ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            });
        });
        let projectId;
        let userId;

        // ì´ìŠˆ ë°ì´í„° ë¡œë“œ
        $(document).ready(function () {
            
            $.ajax({
                url: "jsp/session.jsp",
                type: "GET",
                success: function(response) {
                    if (response.includes("ë¡œê·¸ì¸í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")) {
                        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                        window.location.href = "index.html"; // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                    }
                    else{
                    	userId = response; // ì„¸ì…˜ì—ì„œ ì‚¬ìš©ì IDë¥¼ ê°€ì ¸ì˜¤ëŠ” ë¶€ë¶„
                    	console.log("ìœ ì € id: " + userId);
                    	$.ajax({
                            url: "jsp/projectsession.jsp",
                            type: "GET",
                            success: function(response) {
                                if (response.includes("error")) {
                                    alert("í”„ë¡œì íŠ¸ë¥¼ ë‹¤ì‹œê³¨ë¼ ì£¼ì„¸ìš”.");
                                    window.location.href = "MainPage.html"; // ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
                                }
                                else{
                                	projectId = response; // ì„¸ì…˜ì—ì„œ ì‚¬ìš©ì IDë¥¼ ê°€ì ¸ì˜¤ëŠ” ë¶€ë¶„
                                    console.log("í”„ë¡œì íŠ¸ id: " + projectId);
                                    loadIssues();
                                    console.log("í˜ì´ì§€ ë¡œë“œ + ìœ ì € id, í”„ë¡œì íŠ¸ id ì™„ë£Œ");
                                }
                            },
                            error: function(xhr, status, error) {
                                console.error("ì„¸ì…˜ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                            }
                        });
                        console.log("í˜ì´ì§€ ë¡œë“œ + ìœ ì € id, í”„ë¡œì íŠ¸ id ì™„ë£Œ");
                    }
                },
                error: function(xhr, status, error) {
                    console.error("ì„¸ì…˜ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                }
            });

            function loadIssues() {
            	console.log(projectId);
                $.ajax({
                    url: "jsp/projectIssueList.jsp",
                    type: "POST",
                    data: { projectid: projectId },
                    dataType: "json",
                    success: function (issues) {
                        console.log("âœ… Loaded issues:", issues);
                        displayIssues(issues);
                    },
                    error: function (xhr, status, error) {
                        console.error("âŒ AJAX ì˜¤ë¥˜ ë°œìƒ:", error);
                    }
                });
            }

            function displayIssues(issues) {
                const hazardList = $("#hazardList");
                const issueList = $("#issueList");
                const solvedList = $("#solvedList");

                hazardList.empty();
                issueList.empty();
                solvedList.empty();

                issues.forEach(issue => {
                    if (issue.level === "0") {
                        hazardList.append(getIssues(issue));
                    } else if (issue.level === "1") {
                        issueList.append(getIssues(issue));
                    } else if (issue.level === "2") {
                        solvedList.append(getIssues(issue));
                    }
                });
            }

            function getIssues(issue) {
                return `
                    <div class="issue-item">
                        <span>${issue.title}</span>
                        <span>${issue.description}</span>
                    </div>
                `;
            }
        });
    </script>

</body>
</html>
