<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í”„ë¡œí•„ í˜ì´ì§€</title>
    <link rel="stylesheet" href="css/ProfilePage.css">
    <script src="js/jquery-3.6.0.min.js"></script>
</head>
<body>
    <!-- ìƒë‹¨ë°” -->
    <div class="header">
        <h1>MOLE</h1>
    </div>

    <!-- í”„ë¡œí•„ ì½˜í…ì¸  -->
    <div class="profile-container">
        <div class="profile-info">
            <div class="profile-left">
                <div class="profile-picture"></div>
                <h2 id="userName">ì‚¬ìš©ì ì´ë¦„</h2>
                <p id="userEmail">ì´ë©”ì¼</p>
                <button class="edit-profile-btn">í”„ë¡œí•„ ìˆ˜ì •</button>
                <button class="append-bio-btn">ì¶”ê°€ ì…ë ¥</button>
            </div>
            <div class="profile-bio empty" id="bioPreview">ì†Œê°œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>

        <div class="sections-row">
            <div class="bio-section">
                <p contenteditable="true" id="bioInput">ì—¬ê¸°ì— ê°œì¸ì†Œê°œê¸€ì„ ì‘ì„±í•˜ì„¸ìš”.</p>
            </div>

            <div class="pinned-section">
                <h3>Pinned <span class="customize" id="customizeBtn">customize</span></h3>
                <div id="pinnedProjects" class="pinned-projects"></div>
            </div>
        </div>
    </div>

    <!-- í”„ë¡œí•„ ë©”ë‰´ -->
    <div class="profile-menu-container">
        <img src="public/logo-transparent.png" alt="MOLE PMS Logo" class="profile-btn" id="profileBtn">
        <div class="profile-menu" id="profileMenu">
            <ul>
                <li data-link="MainPage.html">í™ˆ</li>
                <li data-link="TeamPage.html">íŒ€ í˜ì´ì§€</li>
                <li data-link="FindTeam.html">íŒ€ ì°¾ê¸°</li>
                <li data-link="CreateTeam.html">íŒ€ ë§Œë“¤ê¸°</li>
                <li data-link="TeamManage.html">íŒ€ ê´€ë¦¬</li>
                <li data-link="ProfilePage.html">í”„ë¡œí•„</li>
                <li data-link="SettingsPage.html">ì„¤ì •</li>
            </ul>
        </div>
    </div>

    <!-- ëª¨ë‹¬ ì°½ -->
    <div class="modal" id="projectModal">
        <div class="modal-content">
            <h2>í”„ë¡œì íŠ¸ ê´€ë¦¬</h2>
            <label for="projectSelect">í”„ë¡œì íŠ¸ ì„ íƒ</label>
            <select id="projectSelect"></select>

            <label for="newProjectName">ìƒˆ í”„ë¡œì íŠ¸ ì´ë¦„</label>
            <input type="text" id="newProjectName" placeholder="ìƒˆ ì´ë¦„ ì…ë ¥">

            <button id="renameProjectBtn">ì´ë¦„ ë³€ê²½</button>
            <button id="deleteProjectBtn">ì‚­ì œ</button>
            <button id="closeModalBtn" class="close-btn">ë‹«ê¸°</button>
        </div>
    </div>

    <script src="js/core.js"></script>

    <script>
    let userId;

    $(document).ready(function () {
    	 // ğŸ“Œ ì‚¬ì´ë“œë°” ë° í”„ë¡œí•„ ë©”ë‰´ í´ë¦­ ì‹œ í˜ì´ì§€ ì´ë™
        $(".sidebar-link, .profile-menu li").on("click", function () {
            const targetPage = $(this).data("link");
            window.location.href = targetPage;
        });

        // ğŸ“Œ í”„ë¡œí•„ ë²„íŠ¼ í´ë¦­ ì‹œ ë©”ë‰´ í† ê¸€
        const profileBtn = $("#profileBtn");
        const profileMenu = $("#profileMenu");

        profileBtn.on("click", function (event) {
            event.stopPropagation();
            profileMenu.toggleClass("active");
        });

        $(document).on("click", function (event) {
            if (!profileBtn.is(event.target) && !profileMenu.is(event.target) && profileMenu.has(event.target).length === 0) {
                profileMenu.removeClass("active");
            }
        });
    	// ì„¸ì…˜ í™•ì¸
        $.ajax({
            url: "jsp/session.jsp",
            type: "GET",
            success: function(response) {
                if (response.includes("ë¡œê·¸ì¸í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")) {
                    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                    window.location.href = "index.html";
                } else {
                    // userIdì—ì„œ "í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ID:" ë¶€ë¶„ ì œê±°
                    userId = response.replace("í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ID:", "").trim();  
                    console.log("âœ… ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ID:", userId);  // ë””ë²„ê¹… ë¡œê·¸
                    loadUserProfile();
                    loadUserBio();
                    loadUserProjects();
                }
            },
            error: function(xhr, status, error) {
                console.error("ì„¸ì…˜ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            }
        });

        // í”„ë¡œí•„ ìˆ˜ì •
        $(".edit-profile-btn").click(function () {
            const bioContent = $("#bioInput").text().trim();
            if (bioContent !== "") {
                $("#bioPreview").removeClass('empty').text(bioContent);
                saveUserBio(bioContent, false);
            } else {
                $("#bioPreview").addClass('empty').text("ì†Œê°œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.");
            }
        });

        // ì¶”ê°€ ì…ë ¥
        $(".append-bio-btn").click(function () {
            const newBio = $("#bioInput").text().trim();
            if (newBio !== "") {
                const currentBio = $("#bioPreview").hasClass('empty') ? "" : $("#bioPreview").text();
                const updatedBio = currentBio ? `${currentBio}\n${newBio}` : newBio;
                $("#bioPreview").removeClass('empty').text(updatedBio);
                saveUserBio(newBio, true);
            }
        });

        // Customize ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ í‘œì‹œ
        $("#customizeBtn").click(function () {
            populateProjectSelect();
            $("#projectModal").show();
        });

        // ëª¨ë‹¬ ë‹«ê¸°
        $("#closeModalBtn").click(function () {
            $("#projectModal").hide();
        });

        // í”„ë¡œì íŠ¸ ì´ë¦„ ë³€ê²½
        $("#renameProjectBtn").click(function () {
            const projectId = $("#projectSelect").val();
            const newProjectName = $("#newProjectName").val().trim();
            if (newProjectName) {
                $.ajax({
                    url: "jsp/RenameProject.jsp",
                    type: "POST",
                    data: { projectId: projectId, newName: newProjectName },
                    success: function () {
                        alert("í”„ë¡œì íŠ¸ ì´ë¦„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        loadUserProjects();
                        $("#projectModal").hide();
                    },
                    error: function () {
                        alert("í”„ë¡œì íŠ¸ ì´ë¦„ ë³€ê²½ ì‹¤íŒ¨.");
                    }
                });
            } else {
                alert("ìƒˆ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
            }
        });

        // í”„ë¡œì íŠ¸ ì‚­ì œ
        $("#deleteProjectBtn").click(function () {
            const projectId = $("#projectSelect").val();
            $.ajax({
                url: "jsp/DeleteProject.jsp",
                type: "POST",
                data: { projectId: projectId },
                success: function () {
                    alert("í”„ë¡œì íŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    loadUserProjects();
                    $("#projectModal").hide();
                },
                error: function () {
                    alert("í”„ë¡œì íŠ¸ ì‚­ì œ ì‹¤íŒ¨.");
                }
            });
        });
    });

    function saveUserBio(bio, append) {
        $.ajax({
            url: "jsp/SaveBio.jsp",
            type: "POST",
            data: { userId: userId, bio: bio, append: append },
            success: function (response) {
                console.log("ğŸ“¤ BIO ì €ì¥ ì‘ë‹µ:", response); // ë””ë²„ê¹… ë¡œê·¸
                if (response.status === "success") {
                    console.log("âœ… ì†Œê°œê¸€ ì €ì¥ ì„±ê³µ.");
                } else {
                    console.error("âŒ ì†Œê°œê¸€ ì €ì¥ ì‹¤íŒ¨:", response.message);
                }
            },
            error: function (xhr, status, error) {
                console.error("âŒ ì†Œê°œê¸€ ì €ì¥ ì¤‘ ì˜¤ë¥˜:", error);
            }
        });
    }


    function loadUserProfile() {
        $.ajax({
            url: "jsp/GetUserProfile.jsp",
            type: "GET",
            dataType: "json",
            success: function (data) {
                $("#userName").text(data.name);
                $("#userEmail").text(data.email);
            },
            error: function () {
                console.error("ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            }
        });
    }

    function loadUserBio() {
        $.ajax({
            url: "jsp/GetBio.jsp",
            type: "GET",
            data: { userId: userId },
            success: function (response) {
                console.log("ğŸ“¥ BIO ë¶ˆëŸ¬ì˜¤ê¸° ì‘ë‹µ:", response); // ë””ë²„ê¹… ë¡œê·¸
                if (response.status === "success" && response.bio) {
                    $("#bioPreview").removeClass('empty').text(response.bio);
                } else {
                    $("#bioPreview").addClass('empty').text("ì†Œê°œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.");
                }
            },
            error: function (xhr, status, error) {
                console.error("âŒ ì†Œê°œê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            }
        });
    }

    function loadUserProjects() {
        $.ajax({
            url: "jsp/GetUserProjects.jsp",
            type: "GET",
            dataType: "json",
            success: function (projects) {
                $("#pinnedProjects").empty();
                projects.forEach(function (project) {
                    $("#pinnedProjects").append(`<div class="pinned-project" data-id="${project.id}">${project.name}</div>`);
                });
            },
            error: function () {
                console.error("í”„ë¡œì íŠ¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            }
        });
    }

    function populateProjectSelect() {
        $.ajax({
            url: "jsp/GetUserProjects.jsp",
            type: "GET",
            dataType: "json",
            success: function (projects) {
                const projectSelect = $("#projectSelect");
                projectSelect.empty();
                projects.forEach(function (project) {
                    projectSelect.append(`<option value="${project.id}">${project.name}</option>`);
                });
            }
        });
    }
    </script>
</body>
</html>
