<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŒ€ ê²Œì‹œíŒ</title>
    <link rel="stylesheet" href="css/TeamBoard.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

    <div class="header">MOLE</div>

    <div class="container">
        <div class="sidebar">
            <ul>
                <li class="sidebar-link" data-link="MainPage.html">ëŒ€ì‹œë³´ë“œ</li>
                <li class="sidebar-link" data-link="TeamPage.html">íŒ€ í˜ì´ì§€</li>
                <li class="sidebar-link" data-link="GanttChart.html">ê°„íŠ¸ ì°¨íŠ¸</li>
                <li class="sidebar-link" data-link="IssuePage.html">ì´ìŠˆ</li>
                <li class="sidebar-link" data-link="TeamBoard.html">íŒ€ ë³´ë“œ</li>
                <li class="sidebar-link" data-link="TeamSetting.html">íŒ€ ì„¸íŒ…</li>
            </ul>
        </div>

        <div class="main-content">
            <h2>íŒ€ ê²Œì‹œíŒ</h2>
            <button id="createPostBtn">ê¸€ ì‘ì„±</button>
            <div id="postList"></div>
        </div>
    </div>

    <div id="postModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>ìƒˆ ê¸€ ì‘ì„±</h3>
            <input type="text" id="postTitle" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
            <textarea id="postContent" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
            <button id="submitPost">ì‘ì„± ì™„ë£Œ</button>
            <button id="closeModal">ë‹«ê¸°</button>
        </div>
    </div>
	<!-- ğŸ“Œ í”„ë¡œí•„ ë©”ë‰´ (ì˜¤ë¥¸ìª½ í•˜ë‹¨ ìœ„ì¹˜) -->
    <div class="profile-container">
        <img src="public/logo-transparent.png" alt="MOLE PMS Logo" class="profile-btn" id="profileBtn">
        <div class="profile-menu" id="profileMenu">
            <ul>
				<li data-link="MainPage.html">í™ˆ</li>
                <li data-link="TeamPage.html">íŒ€ í˜ì´ì§€</li> <!-- âœ… íŒ€ í˜ì´ì§€ ì¶”ê°€ -->
                <li data-link="FindTeam.html">íŒ€ ì°¾ê¸°</li>
                <li data-link="CreateTeam.html">íŒ€ ë§Œë“¤ê¸°</li>
                <li data-link="TeamManage.html">íŒ€ ê´€ë¦¬</li>
                <li data-link="ProfilePage.html">í”„ë¡œí•„</li>
                <li data-link="SettingsPage.html">ì„¤ì •</li> </ul>
        </div>
    </div>
<script>
$(document).ready(function() {
    let projectId, userId;

    // ì„¸ì…˜ì—ì„œ projectId ê°€ì ¸ì˜¤ê¸°
    $.ajax({
        url: "jsp/projectsession.jsp",
        type: "GET",
        success: function(response) {
            projectId = response.trim();
            if (!projectId || projectId === "error") {
                alert("í”„ë¡œì íŠ¸ë¥¼ ë‹¤ì‹œ ì„ íƒí•˜ì„¸ìš”.");
                window.location.href = "MainPage.html";
            } else {
                loadPosts(projectId);
            }
        },
        error: function() {
            alert("í”„ë¡œì íŠ¸ IDë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
    });

    // ì„¸ì…˜ì—ì„œ userId ê°€ì ¸ì˜¤ê¸°
    $.ajax({
        url: "jsp/session.jsp",
        type: "GET",
        success: function(response) {
            if (response.includes("ë¡œê·¸ì¸í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")) {
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                window.location.href = "index.html";
            } else {
                userId = response.trim();
            }
        },
        error: function() {
            alert("ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
    });
	
    // ğŸ“Œ ì‚¬ì´ë“œë°” ë° í”„ë¡œí•„ ë©”ë‰´ í´ë¦­ ì‹œ í˜ì´ì§€ ì´ë™
    $(".sidebar-link, .profile-menu li").on("click", function () {
        const targetPage = $(this).data("link");
        window.location.href = targetPage;
    });

    // ğŸ“Œ í”„ë¡œí•„ ë²„íŠ¼ í´ë¦­ ì‹œ ë©”ë‰´ í† ê¸€
    const profileBtn = $("#profileBtn");
    const profileMenu = $("#profileMenu");

    profileBtn.on("click", function (event) {
        event.stopPropagation();
        profileMenu.toggleClass("active");
    });

    $(document).on("click", function (event) {
        if (!profileBtn.is(event.target) && !profileMenu.is(event.target) && profileMenu.has(event.target).length === 0) {
            profileMenu.removeClass("active");
        }
    });
    
    // ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
    function loadPosts(projectId) {
        $.ajax({
            url: "jsp/GetPosts.jsp",
            type: "GET",
            data: { projectId: projectId },
            dataType: "json",
            success: function(posts) {
                displayPosts(posts);
            },
            error: function() {
                alert("ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        });
    }

    // ê²Œì‹œê¸€ í‘œì‹œ
    function displayPosts(posts) {
        let postList = $("#postList");
        postList.empty();

        posts.forEach(post => {
            let postHtml = `
                <div class="post">
                    <h3>${post.title || "ì œëª© ì—†ìŒ"}</h3>
                    <p>${post.content || "ë‚´ìš© ì—†ìŒ"}</p>
                    <small>ì‘ì„±ì: ${post.userId || "ì•Œ ìˆ˜ ì—†ìŒ"}</small>
                    <small>ì‘ì„±ì¼: ${post.createdAt}</small>
                </div>`;
            postList.append(postHtml);
        });
    }

    // ê¸€ ì‘ì„± ëª¨ë‹¬ ì—´ê¸°
    $("#createPostBtn").on("click", function() {
        $("#postModal").show();
    });

    // ëª¨ë‹¬ ë‹«ê¸°
    $("#closeModal").on("click", function() {
        $("#postModal").hide();
    });

    // ê¸€ ì‘ì„± ì™„ë£Œ
    $("#submitPost").on("click", function() {
        let title = $("#postTitle").val().trim();
        let content = $("#postContent").val().trim();

        if (!title || !content || !userId || !projectId) {
            alert("ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        $.ajax({
            url: "jsp/CreatePost.jsp",
            type: "POST",
            data: { title, content, projectId, userId },
            success: function(response) {
                if (response.status === "success") {
                    alert("ê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    $("#postModal").hide();
                    loadPosts(projectId);
                } else {
                    alert("ê¸€ ì‘ì„± ì‹¤íŒ¨: " + response.message);
                }
            },
            error: function() {
                alert("ê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        });
    });
});
</script>

</body>
</html>
