<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="stylesheet" type="text/css" href="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.css">
    <script src="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.js"></script>
    <title>MOLE - Gantt Chart</title>
    <link rel="stylesheet" href="./css/GanttChart.css">
    <script src="js/jquery-3.6.0.min.js"></script>
</head>
<body>

    <!-- ğŸ“Œ ìƒë‹¨ë°” -->
    <div class="header">
        <h1>MOLE</h1>
    </div>

    <div class="container">
        <!-- ğŸ“Œ ì™¼ìª½ ì‚¬ì´ë“œë°” -->
        <div class="sidebar">
            <ul>
                <li class="sidebar-link" data-link="MainPage.html">ëŒ€ì‹œë³´ë“œ</li>
                <li class="sidebar-link" data-link="TeamPage.html">íŒ€ í˜ì´ì§€</li>
                <li class="sidebar-link active" data-link="GanttChart.html">ê°„íŠ¸ ì°¨íŠ¸</li>
                <li class="sidebar-link" data-link="IssuePage.html">ì´ìŠˆ</li>
                <li class="sidebar-link" data-link="TeamBoard.html">íŒ€ ë³´ë“œ</li>
                <li class="sidebar-link" data-link="TeamSetting.html">íŒ€ ì„¸íŒ…</li>
            </ul>
        </div>

        <!-- ğŸ“Œ ë©”ì¸ ì»¨í…ì¸  (ê°„íŠ¸ì°¨íŠ¸) -->
        <div class="main-content">
            <h2>Gantt Chart</h2>
            <div id="ganttChart" style="width: 100%; height: 700px"></div>
        </div>
    </div>

    <!-- ğŸ“Œ í”„ë¡œí•„ ë©”ë‰´ (ì˜¤ë¥¸ìª½ í•˜ë‹¨ ìœ„ì¹˜) -->
    <div class="profile-container">
      <img src="public/logo-transparent.png" alt="MOLE PMS Logo" class="profile-btn" id="profileBtn">
      <div class="profile-menu" id="profileMenu">
        <ul>
          <li data-link="MainPage.html">í™ˆ</li>
          <li data-link="TeamPage.html">íŒ€ í˜ì´ì§€</li>
          <li data-link="ProfilePage.html">í”„ë¡œí•„</li>
          <li data-link="jsp/logout.jsp">ë¡œê·¸ì•„ì›ƒ</li>
        </ul>
      </div>
    </div>
    <script>
    let projectId;
    let userId;
    let projectData = {}; // í”„ë¡œì íŠ¸ ë°ì´í„° ì €ì¥ ë³€ìˆ˜

    window.addEventListener("DOMContentLoaded", function () {
        gantt.init("ganttChart");

        // âœ… ë‚ ì§œ í¬ë§· ì„¤ì •
        gantt.config.date_format = "%Y-%m-%d";
        gantt.config.xml_date = "%Y-%m-%d";
        gantt.config.drag_move = true;
        checkUserSession();
    });
    
 // âœ… ì‚¬ì´ë“œë°” ë° í”„ë¡œí•„ ë©”ë‰´ í´ë¦­ ì‹œ í˜ì´ì§€ ì´ë™
    $(document).ready(function () {
        $(".sidebar-link, .profile-menu li").on("click", function () {
            const targetPage = $(this).data("link");
            window.location.href = targetPage;
        });

        // âœ… í”„ë¡œí•„ ë²„íŠ¼ í´ë¦­ ì‹œ ë©”ë‰´ í† ê¸€
        const profileBtn = $("#profileBtn");
        const profileMenu = $("#profileMenu");

        profileBtn.on("click", function (event) {
            event.stopPropagation();
            profileMenu.toggleClass("active");
        });

        $(document).on("click", function (event) {
            if (!profileBtn.is(event.target) && !profileMenu.is(event.target) && profileMenu.has(event.target).length === 0) {
                profileMenu.removeClass("active");
            }
        });
    });


    // âœ… ìœ ì € ì„¸ì…˜ í™•ì¸
    function checkUserSession() {
        $.ajax({
            url: "jsp/session.jsp",
            type: "GET",
            success: function(response) {
                if (response.includes("ë¡œê·¸ì¸í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")) {
                    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                    window.location.href = "index.html";
                } else {
                    userId = response.trim();
                    checkProjectSession();
                }
            }
        });
    }

    // âœ… í”„ë¡œì íŠ¸ ì„¸ì…˜ í™•ì¸
    function checkProjectSession() {
        $.ajax({
            url: "jsp/projectsession.jsp",
            type: "GET",
            success: function(response) {
                if (response.includes("error")) {
                    alert("í”„ë¡œì íŠ¸ë¥¼ ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.");
                    window.location.href = "MainPage.html";
                } else {
                    projectId = response.trim();
                    loadGanttChart();
                }
            }
        });
    }

    function convertDate(date) {
        if (!date) return "";

        let parsedDate = new Date(date);

        // âœ… ë‚ ì§œ ë³€í™˜ ì˜¤ë¥˜ ë°©ì§€
        if (isNaN(parsedDate.getTime())) {
            console.error("âŒ Invalid Date:", date);
            return "";
        }

        let year = parsedDate.getFullYear();
        let month = String(parsedDate.getMonth() + 1).padStart(2, "0");
        let day = String(parsedDate.getDate()).padStart(2, "0");

        return `${year}-${month}-${day}`; // âœ… YYYY-MM-DD í˜•ì‹ ìœ ì§€
    }


    // âœ… ê¸°ê°„ ê³„ì‚° í•¨ìˆ˜
    function calculateDuration(startDate, endDate) {
        if (!startDate || !endDate) return 1;
        return Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24));
    }

    // âœ… Gantt Chart ë°ì´í„° ë¡œë“œ
    function loadGanttChart() {
        $.ajax({
            url: "jsp/GetProject.jsp",
            type: "POST",
            data: { projectId },
            dataType: "json",
            success: function (data) {
                if (data.error) {
                    console.error("âŒ í”„ë¡œì íŠ¸ ë¡œë“œ ì˜¤ë¥˜:", data.error);
                    return;
                }

                projectData = data;

                $.ajax({
                    url: "jsp/GetTasks.jsp",
                    type: "POST",
                    data: { projectId },
                    dataType: "json",
                    success: function (tasksData) {
                        if (tasksData.error) {
                            console.error("âŒ í• ì¼ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", tasksData.error);
                            return;
                        }
                        
                        let maxEndDate = projectData.end_date; // ê¸°ì¡´ í”„ë¡œì íŠ¸ ì¢…ë£Œì¼
                        tasksData.forEach((task) => {
                            if (new Date(task.endDate) > new Date(maxEndDate)) {
                                maxEndDate = task.endDate; // ê°€ì¥ ëŠ¦ì€ ì¢…ë£Œì¼ ì°¾ê¸°
                            }
                        });

                        console.log("ğŸŸ¡ ìµœì¢… í”„ë¡œì íŠ¸ ì¢…ë£Œì¼:", maxEndDate);

                        // âœ… `end_date`ê°€ ë³€ê²½ë˜ì—ˆìœ¼ë©´ ì—…ë°ì´íŠ¸ ì‹¤í–‰
                        if (maxEndDate !== projectData.end_date) {
                            updateProjectEndDate(projectData.id, maxEndDate);
                        }

                        const ganttData = [{
                            id: projectData.id,
                            text: projectData.name,
                            start_date: new Date(projectData.created_at),
                            duration: calculateDuration(projectData.created_at, maxEndDate),
                            open: true
                        }];

                        tasksData.forEach((task) => {
                            ganttData.push({
                                id: task.scheduleId,
                                text: task.taskName,
                                start_date: new Date(task.startDate),
                                duration: calculateDuration(task.startDate, task.endDate),
                                progress: task.status === "todo" ? 0 : task.status === "inProgress" ? 0.5 : 1,
                                parent: projectData.id,
                                open: true
                            });
                        });

                        // âœ… "New Task" ì¶”ê°€ (ì„œë²„ ì €ì¥ X, í´ë¦­í•˜ë©´ ì¶”ê°€ ì°½ ì—´ë¦¼)
                        ganttData.push({
                            id: "newTask",
                            text: "New Task",
                            start_date: new Date(),
                            duration: 1,
                            progress: 0,
                            parent: projectData.id,
                            status: "todo",
                            open: true
                        });

                        renderGanttChart(ganttData);
                    }
                });
            }
        });
    }

    // âœ… Gantt Chart ë Œë”ë§
    function renderGanttChart(data) {
        gantt.clearAll();
        gantt.parse({ data });
    }

    // âœ… ì‘ì—… ì´ë™ ì œí•œ (í”„ë¡œì íŠ¸ ì‹œì‘ì¼ ì´ì „ìœ¼ë¡œ ì´ë™ ê¸ˆì§€)
    gantt.attachEvent("onBeforeTaskMove", function(id, parent, tindex){
        const task = gantt.getTask(id);
        const projectStartDate = new Date(projectData.created_at);

        if (new Date(task.start_date) < projectStartDate) {
        	loadGanttChart()
            alert("ì‘ì—…ì˜ ì‹œì‘ì¼ì€ í”„ë¡œì íŠ¸ ì‹œì‘ì¼ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤.");
            return false;
        }
        return true;
    });

    // âœ… ì‘ì—… ì´ë™ (ë“œë˜ê·¸ & ë“œë¡­) í›„ ì„œë²„ì— ì €ì¥
    gantt.attachEvent("onAfterTaskDrag", function (id, mode, e) {
        const task = gantt.getTask(id);
        const projectStartDate = new Date(projectData.created_at);

        if (new Date(task.start_date) < projectStartDate) {
            alert("ì‘ì—…ì˜ ì‹œì‘ì¼ì€ í”„ë¡œì íŠ¸ ì‹œì‘ì¼ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤.");
            loadGanttChart();
            return false;
        }
        console.log("ğŸŸ¡ Task ìˆ˜ì • ìš”ì²­ ë°ì´í„°:", task);
        console.log("ğŸŸ¡ task.status ê°’ í™•ì¸:", task.status); // âœ… ì—¬ê¸°ì„œ status í™•ì¸
        updateTask(task);
        return true;
    });

    // âœ… ì‘ì—… ìˆ˜ì • ì‹œ ì„œë²„ì— ì—…ë°ì´íŠ¸
    gantt.attachEvent("onAfterTaskUpdate", function(id, task) {
        updateTask(task);
    });
	
    gantt.attachEvent("onBeforeTaskChanged", function(id, mode, task) {
        if (mode === gantt.config.drag_mode.progress) {
            return false; // âœ… progress ê°’ì´ ìˆ˜ì •ë˜ì§€ ì•Šë„ë¡ ë°©ì§€
        }
        return true;
    });

 // âœ… ì‘ì—… ì—…ë°ì´íŠ¸
    function updateTask(task) {
        task.status = task.progress === 0 ? "todo" : task.progress === 0.5 ? "inProgress" : "completed";
        $.ajax({
            url: "jsp/UpdateTaskbyID.jsp",
            type: "POST",
            data: {
                scheduleId: task.id,
                taskName: task.text, // âœ… ì´ë¦„ ì¶”ê°€
                startDate: convertDate(task.start_date),
                endDate: convertDate(task.end_date),
                status: task.status
            },
            success: function(response) {
            	console.log("updatetaskbyid"+response);
                loadGanttChart();
            }
        });
    }

    
	
    // âœ… "New Task" ì„ íƒ ì‹œ ìƒˆ ì‘ì—… ì¶”ê°€
    gantt.attachEvent("onTaskDblClick", function(id, e){
        const task = gantt.getTask(id);
        if (task.id === "newTask") {
            addNewTask();
            return false;
        }
        return true;
    });

    // âœ… ìƒˆ ì‘ì—… ì¶”ê°€
    function addNewTask() {
        const newTask = {
            id: "newTask", // âœ… IDë¥¼ "newTask"ë¡œ ì„¤ì • (ì„ì‹œ ID)
            text: "ìƒˆ ì‘ì—…",
            start_date: new Date(),
            duration: 1,
            progress: 0,
            parent: projectData.id,
            status: "todo",
            open: true
        };

        gantt.addTask(newTask);
        saveNewTask(newTask)
        loadGanttChart();
    }

    // âœ… ì‘ì—… ì¶”ê°€ í›„ ì„œë²„ì— ì €ì¥
    gantt.attachEvent("onAfterTaskAdd", function(id, task) {
        if (task.id !== "newTask") {
            saveNewTask(task);
        }
    });

    // âœ… ì‘ì—… ì¶”ê°€
    function saveNewTask(task) {
    $.ajax({
        url: "jsp/AddTask.jsp",
        type: "POST",
        dataType: "json",
        data: {
            taskName: task.text,
            startDate: convertDate(task.start_date),
            endDate: convertDate(task.end_date),
            projectId: projectId,
            status: task.status
        },
        success: function(response) {
            console.log("âœ… ìƒˆ ì‘ì—… ì¶”ê°€ ì„±ê³µ:", response);

            if (response.success) {
                console.log("âœ… ì„œë²„ì— ì‘ì—…ì´ ì¶”ê°€ë¨. ìµœì‹  ID ê°€ì ¸ì˜¤ê¸°...");

                // âœ… ê¸°ì¡´ DAO ë©”ì„œë“œ í™œìš©: í”„ë¡œì íŠ¸ì˜ ìµœì‹  ì‘ì—… ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
                fetchLatestTaskFromProject(task);
            } else {
                console.error("âŒ ì‘ì—… ì¶”ê°€ ì‹¤íŒ¨: ì„œë²„ ì‘ë‹µ -", response);
            }
        },
        error: function(xhr, status, error) {
            console.error("âŒ ì‘ì—… ì¶”ê°€ ì‹¤íŒ¨:", error);
        }
    });
	}
    
    function updateProjectEndDate(projectId, newEndDate) {
        $.ajax({
            url: "jsp/UpdateProjectEndDate.jsp",
            type: "POST",
            data: {
                projectId: projectId,
                endDate: newEndDate
            },
            dataType: "json",
            success: function(response) {
                console.log("âœ… í”„ë¡œì íŠ¸ ì¢…ë£Œì¼ ì—…ë°ì´íŠ¸ ì„±ê³µ:", response);
            },
            error: function(xhr, status, error) {
                console.error("âŒ í”„ë¡œì íŠ¸ ì¢…ë£Œì¼ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", error);
            }
        });
    }

	
    //ìµœì‹  ì‘ì—…ì˜ scheduleId ê°€ì ¸ì˜¤ê¸°
    function fetchLatestTaskFromProject(task) {
        $.ajax({
            url: "jsp/GetTasks.jsp", // âœ… ê¸°ì¡´ DAO ë©”ì„œë“œ í™œìš© (ìˆ˜ì • X)
            type: "POST",
            data: { projectId: projectId }, // âœ… í˜„ì¬ í”„ë¡œì íŠ¸ ID ê¸°ì¤€ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°
            dataType: "json",
            success: function(response) {
                console.log("âœ… í”„ë¡œì íŠ¸ ë‚´ ìµœì‹  ì‘ì—… ê°€ì ¸ì˜¤ê¸° ì„±ê³µ:", response);

                if (response.length > 0) {
                    let latestTask = response[response.length - 1]; // âœ… ê°€ì¥ ìµœê·¼ ì¶”ê°€ëœ ì‘ì—…

                    console.log("âœ… Gantt Chart ID ë³€ê²½:", task.id, "->", latestTask.scheduleId);

                    gantt.changeTaskId(task.id, latestTask.scheduleId); // âœ… ID ë³€ê²½
                    task.id = latestTask.scheduleId; // âœ… ë‚´ë¶€ì ìœ¼ë¡œë„ ID ë³€ê²½
                }

                loadGanttChart(); // âœ… ìµœì‹  ë°ì´í„° ë°˜ì˜
            },
            error: function(xhr, status, error) {
                console.error("âŒ ìµœì‹  ì‘ì—… ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", error);
            }
        });
    }


	
    // âœ… ì‘ì—… ì‚­ì œ
    gantt.attachEvent("onAfterTaskDelete", function(id){
        if (id !== "newTask") {
            $.ajax({
                url: "jsp/DeleteTask.jsp",
                type: "POST",
                data: { scheduleId: id },
                success: function(response) {
                    console.log("âœ… ì‘ì—… ì‚­ì œ ì„±ê³µ:", response);
                    loadGanttChart();
                }
            });
        }
    });


    </script>
</body>
</html>
