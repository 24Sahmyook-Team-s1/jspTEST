<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<link rel="stylesheet" type="text/css"
	href="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.css">
<script src="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.js"></script>
<title>MOLE - Gantt Chart</title>
<link rel="stylesheet" href="./css/GanttChart.css">
<script src="js/jquery-3.6.0.min.js"></script>
</head>
<body>

	<!-- ğŸ“Œ ìƒë‹¨ë°” -->
	<div class="header">
		<h1>MOLE</h1>
	</div>

	<div class="container">
		<!-- ğŸ“Œ ì™¼ìª½ ì‚¬ì´ë“œë°” -->
		<div class="sidebar">
			<ul>
				<li class="sidebar-link" data-link="MainPage.html">ëŒ€ì‹œë³´ë“œ</li>
				<li class="sidebar-link" data-link="TeamPage.html">íŒ€ í˜ì´ì§€</li>
				<li class="sidebar-link" data-link="GanttChart.html">ê°„íŠ¸ ì°¨íŠ¸</li>
				<li class="sidebar-link" data-link="IssuePage.html">ì´ìŠˆ</li>
				<li class="sidebar-link" data-link="TeamBoard.html">íŒ€ ë³´ë“œ</li>
				<li class="sidebar-link active" data-link="TeamSetting.html">íŒ€
					ì„¸íŒ…</li>
			</ul>
		</div>

		<!-- ğŸ“Œ ë©”ì¸ ì»¨í…ì¸  (ê°„íŠ¸ì°¨íŠ¸) -->
		<div class="main-content">
			<h2>Gantt Chart</h2>
			<div id="ganttChart" style="width: 100%; height: 700px"></div>
		</div>
	</div>

	<!-- ğŸ“Œ í”„ë¡œí•„ ë©”ë‰´ (ì˜¤ë¥¸ìª½ í•˜ë‹¨ ìœ„ì¹˜) -->
	<div class="profile-container">
		<img src="public/logo-transparent.png" alt="MOLE PMS Logo"
			class="profile-btn" id="profileBtn">
		<div class="profile-menu" id="profileMenu">
			<ul>
				<li data-link="MainPage.html">í™ˆ</li>
				<li data-link="TeamPage.html">íŒ€ í˜ì´ì§€</li>
				<!-- âœ… íŒ€ í˜ì´ì§€ ì¶”ê°€ -->
				<li data-link="FindTeam.html">íŒ€ ì°¾ê¸°</li>
				<li data-link="CreateTeam.html">íŒ€ ë§Œë“¤ê¸°</li>
				<li data-link="TeamManage.html">íŒ€ ê´€ë¦¬</li>
				<li data-link="ProfilePage.html">í”„ë¡œí•„</li>
				<li data-link="SettingsPage.html">ì„¤ì •</li>
			</ul>
		</div>
	</div>

	<!-- ëª¨ë‹¬ ì°½ -->
	<div id="taskModal" class="modal" style="display: none;">
		<div class="modal-content">
			<h3>ì‘ì—… ìˆ˜ì •</h3>
			<form id="taskForm">
				<label for="taskName">ì‘ì—…ëª…:</label> <input type="text" id="taskName"
					name="taskName" required> <label for="startDate">ì‹œì‘ì¼:</label>
				<input type="date" id="startDate" name="startDate" required>

				<label for="endDate">ì¢…ë£Œì¼:</label> <input type="date" id="endDate"
					name="endDate" required> <label for="progress">ì§„í–‰ë¥ :</label>
				<input type="number" id="progress" name="progress" min="0" max="100"
					required>

				<button type="submit">ì €ì¥</button>
				<button type="button" class="close">ë‹«ê¸°</button>
			</form>
		</div>
	</div>

	<script>
	let projectId;
    let userId;
	
	window.addEventListener("DOMContentLoaded", function () {
		gantt.init("ganttChart");

        // ê°„íŠ¸ ì°¨íŠ¸ ì„¤ì •
        gantt.config.columns = [
            { name: "text", label: "Task name", width: "*", tree: true },
            { name: "start_date", label: "Start date", align: "center", width: 100 },
            { name: "duration", label: "Duration", align: "center", width: 70 },
            { name: "progress", label: "Progress", align: "center", width: 70 }
        ];

        gantt.config.scale_unit = "week";
        gantt.config.date_scale = "%F %Y";
        gantt.config.subscales = [
            { unit: "day", step: 1, date: "%j, %D" }
        ];

        gantt.config.fit_tasks = true;
        gantt.config.autofit = true;
    });
		
	// ì„¸ì…˜ í™•ì¸ ë™ì‘
    $(document).ready(function () {
        
        $.ajax({
            url: "jsp/session.jsp",
            type: "GET",
            success: function(response) {
                if (response.includes("ë¡œê·¸ì¸í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")) {
                    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                    window.location.href = "index.html"; // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                }
                else{
                	userId = response.trim(); // ì„¸ì…˜ì—ì„œ ì‚¬ìš©ì IDë¥¼ ê°€ì ¸ì˜¤ëŠ” ë¶€ë¶„
                	console.log("ìœ ì € id: " + userId);
                	$.ajax({
                        url: "jsp/projectsession.jsp",
                        type: "GET",
                        success: function(response) {
                            if (response.includes("error")) {
                                alert("í”„ë¡œì íŠ¸ë¥¼ ë‹¤ì‹œê³¨ë¼ ì£¼ì„¸ìš”.");
                                window.location.href = "MainPage.html"; // ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
                            }
                            else{
                            	projectId = response.trim(); // ì„¸ì…˜ì—ì„œ ì‚¬ìš©ì IDë¥¼ ê°€ì ¸ì˜¤ëŠ” ë¶€ë¶„
                                console.log("í”„ë¡œì íŠ¸ id: " + projectId);
                                loadGanttChart();
                                console.log("í˜ì´ì§€ ë¡œë“œ + ìœ ì € id, í”„ë¡œì íŠ¸ id ì™„ë£Œ");
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error("ì„¸ì…˜ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                        }
                    });
                    console.log("í˜ì´ì§€ ë¡œë“œ + ìœ ì € id, í”„ë¡œì íŠ¸ id ì™„ë£Œ");
                }
            },
            error: function(xhr, status, error) {
                console.error("ì„¸ì…˜ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            }
        });
        // ğŸ“Œ ì‚¬ì´ë“œë°” ë° í”„ë¡œí•„ ë©”ë‰´ í´ë¦­ ì‹œ í˜ì´ì§€ ì´ë™
        $(".sidebar-link, .profile-menu li").on("click", function () {
            const targetPage = $(this).data("link");
            window.location.href = targetPage;
        });

        // ğŸ“Œ í”„ë¡œí•„ ë²„íŠ¼ í´ë¦­ ì‹œ ë©”ë‰´ í† ê¸€
        const profileBtn = $("#profileBtn");
        const profileMenu = $("#profileMenu");

        profileBtn.on("click", function (event) {
            event.stopPropagation();
            profileMenu.toggleClass("active");
        });

        $(document).on("click", function (event) {
            if (!profileBtn.is(event.target) && !profileMenu.is(event.target) && profileMenu.has(event.target).length === 0) {
                profileMenu.removeClass("active");
            }
        });
     	// ì „ì—­ ë³€ìˆ˜ë¡œ projectData ì •ì˜
        let projectData = {};

        // ì‘ì—… ì—…ë°ì´íŠ¸ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        gantt.attachEvent("onAfterTaskUpdate", function (id, task) {
            console.log("onAfterTaskUpdate");
            saveTaskChanges(task);
            return true;
        });

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        gantt.attachEvent("onAfterTaskDrag", function (id, mode, e) {
            console.log("onAfterTaskDrag");
            const task = gantt.getTask(id);
            const projectStartDate = new Date(projectData.created_at);

            // ë“œë˜ê·¸ ì´ë™ í›„ì˜ ì‹œì‘ì¼ ê³„ì‚°
            const newStartDate = new Date(task.start_date);
            
            // ì‘ì—…ì˜ ìƒˆë¡œìš´ ì‹œì‘ì¼ì´ í”„ë¡œì íŠ¸ ì‹œì‘ì¼ë³´ë‹¤ ì´ì „ì¸ì§€ ê²€ì‚¬
            if (newStartDate < projectStartDate) {
                alert("ì‘ì—…ì˜ ì‹œì‘ì¼ì€ í”„ë¡œì íŠ¸ì˜ ì‹œì‘ì¼ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤."); // ê²½ê³  ë©”ì‹œì§€
                loadGanttChart()
                return false; // ë“œë˜ê·¸ ì·¨ì†Œ
            }
            saveTaskChanges(task);
            return true;
        });

        // ì‘ì—… ê¸°ê°„ ë³€ê²½ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        gantt.attachEvent("onAfterTaskResize", function (id, mode, e) {
            console.log("onAfterTaskResize");
            const task = gantt.getTask(id);
            const projectStartDate = new Date(projectData.created_at);

            // ë“œë˜ê·¸ ì´ë™ í›„ì˜ ì‹œì‘ì¼ ê³„ì‚°
            const newStartDate = new Date(task.start_date);
            
            // ì‘ì—…ì˜ ìƒˆë¡œìš´ ì‹œì‘ì¼ì´ í”„ë¡œì íŠ¸ ì‹œì‘ì¼ë³´ë‹¤ ì´ì „ì¸ì§€ ê²€ì‚¬
            if (newStartDate < projectStartDate) {
                alert("ì‘ì—…ì˜ ì‹œì‘ì¼ì€ í”„ë¡œì íŠ¸ì˜ ì‹œì‘ì¼ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤."); // ê²½ê³  ë©”ì‹œì§€
                loadGanttChart()
                return false; // ë“œë˜ê·¸ ì·¨ì†Œ
            }
            saveTaskChanges(task);
            return true;
        });
        
        // í• ì¼ í´ë¦­
        gantt.attachEvent("onTaskDblClick", function (id, e) {
        	console.log("onTaskDblClick");
            const task = gantt.getTask(id);

            console.log(task);

            // ë¶€ëª¨(Taskê°€ ì•„ë‹Œ í”„ë¡œì íŠ¸) í´ë¦­ ë°©ì§€
            if (task.parent && gantt.getTask(task.parent)) {
                openTaskModal(task);
            }

            return true;
        });



        // ê°„íŠ¸ js ì‹œì‘
        function loadGanttChart() {
            console.log("projectId: " + projectId);
            
            // í”„ë¡œì íŠ¸ ê¸°ë³¸ ì •ë³´ ë¨¼ì € ê°€ì ¸ì˜¤ê¸°
            $.ajax({
                url: "jsp/GetProject.jsp",
                type: "POST",
                data: { projectId },
                dataType: "json",
                success: function (data) {
                    projectData = data; // projectDataë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
                    console.log("âœ… í”„ë¡œì íŠ¸ ë°ì´í„° ìˆ˜ì‹ :", projectData);
                    
                    // í•´ë‹¹ í”„ë¡œì íŠ¸ì˜ í• ì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                    $.ajax({
                        url: "jsp/GetTasks.jsp",
                        type: "POST",
                        data: { projectId },
                        dataType: "json",
                        success: function (tasksData) {
                            console.log("âœ… í• ì¼ ë°ì´í„° ìˆ˜ì‹ :", tasksData);
                            
                            // í”„ë¡œì íŠ¸ ì‹œì‘ì¼ ê°€ì ¸ì˜¤ê¸°
                            const projectStartDate = new Date(projectData.created_at);
                            
                            // ë°ì´í„° êµ¬ì¡° ë³€í™˜
                            const ganttData = [{
                                id: projectData.id,
                                text: projectData.name,
                                start_date: convertDate(projectData.created_at),
                                duration: calculateDuration(
                                    projectData.created_at, 
                                    tasksData.reduce((maxDate, task) => {
                                        return new Date(task.endDate) > new Date(maxDate) ? task.endDate : maxDate;
                                    }, projectData.created_at)
                                ),
                                open: true
                            }];

                            // í• ì¼ ë°ì´í„° ì¶”ê°€
                            tasksData.forEach((task) => {
                                let progress = 0;
                                if (task.status === "todo") {
                                    progress = 0; // ì‹œì‘í•˜ì§€ ì•ŠìŒ
                                } else if (task.status === "inProgress") {
                                    progress = 0.5; // ì§„í–‰ ì¤‘
                                } else if (task.status === "completed") {
                                    progress = 1; // ì™„ë£Œ
                                } else {
                                    progress = 0; // ì•Œ ìˆ˜ ì—†ëŠ” ìƒíƒœ
                                }

                                // ì‘ì—… ì‹œì‘ì¼ ê²€ì‚¬ ë° ë³€ê²½
                                const taskStartDate = new Date(task.startDate);
                                if (taskStartDate < projectStartDate) {
                                    // ì‘ì—… ì‹œì‘ì¼ì„ í”„ë¡œì íŠ¸ ì‹œì‘ì¼ë¡œ ë³€ê²½í•˜ê³ , ê¸°ê°„ì„ ê¸°ë³¸ 1ë¡œ ì„¤ì •
                                    ganttData.push({
                                        id: task.scheduleId,
                                        text: task.taskName,
                                        start_date: convertDate(projectStartDate.toISOString().split('T')[0]), // í”„ë¡œì íŠ¸ ì‹œì‘ì¼ë¡œ ë³€ê²½
                                        duration: 1, // ê¸°ë³¸ ê¸°ê°„ 1
                                        progress: progress, // ìƒíƒœì— ë”°ë¥¸ ì§„í–‰ë¥ 
                                        parent: projectData.id
                                    });
                                } else {
                                    ganttData.push({
                                        id: task.scheduleId,
                                        text: task.taskName,
                                        start_date: convertDate(task.startDate), // ì›ë˜ ì‘ì—…ì˜ ì‹œì‘ì¼ ì‚¬ìš©
                                        duration: calculateDuration(task.startDate, task.endDate), // ì›ë˜ ê¸°ê°„ ì‚¬ìš©
                                        progress: progress, // ìƒíƒœì— ë”°ë¥¸ ì§„í–‰ë¥ 
                                        parent: projectData.id
                                    });
                                }
                            });

                            // ê°„íŠ¸ ì°¨íŠ¸ ë Œë”ë§
                            renderGanttChart(ganttData);
                        },
                        error: function (xhr, status, error) {
                            console.error("âŒ í• ì¼ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", error);
                        }
                    });
                },
                error: function (xhr, status, error) {
                    console.error("âŒ í”„ë¡œì íŠ¸ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", error);
                }
            });
        }


        // ë‚ ì§œ ë³€í™˜ í•¨ìˆ˜ (yyyy-mm-dd â†’ dd-mm-yyyy)
        function convertDate(dateString) {
            const [year, month, day] = dateString.split('-');
            return `${day}-${month}-${year}`;
        }

        // ê¸°ê°„ ê³„ì‚° í•¨ìˆ˜
        function calculateDuration(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diff = end - start;
            return Math.ceil(diff / (1000 * 60 * 60 * 24));
        }

        // ê°„íŠ¸ ì°¨íŠ¸ ë Œë”ë§ í•¨ìˆ˜
        function renderGanttChart(data) {
            gantt.init("ganttChart");
            
            // ê°„íŠ¸ ì°¨íŠ¸ ì„¤ì •
            gantt.config.columns = [
                {name: "text", label: "Task name", width: "*", tree: true },
                {name: "start_date", label: "Start", align: "center", width: 100 },
                {name: "duration", label: "Duration", align: "center", width: 80 },
                {name: "progress", label: "Progress", align: "center", width: 80 }
            ];
            
            gantt.config.scale_unit = "day";
            gantt.config.date_scale = "%d %M";
            gantt.config.subscales = [
                {unit: "week", step: 1, date: "Week #%W"}
            ];
            
            gantt.templates.task_class = function(start, end, task) {
                return task.parent ? "child-task" : "parent-project";
            };
            
            gantt.parse({ data });
        }
        

        	// ì‘ì—… ë³€ê²½ ì‚¬í•­ ì €ì¥ í•¨ìˆ˜
           function saveTaskChanges(task) {
               const convertToServerDate = (date) => {
                   const year = date.getFullYear();
                   const month = String(date.getMonth() + 1).padStart(2, "0");
                   const day = String(date.getDate()).padStart(2, "0");
                   return `${year}-${month}-${day}`;
               };
               
               let status = "todo";
               
               if (task.duration > 0) {
                   status = "inProgress";
               } else if (task.duration === 1) {
                   status = "completed";
               }

               const taskData = {
                   scheduleId: task.id,
                   startDate: convertToServerDate(task.start_date),
                   endDate: convertToServerDate(gantt.calculateEndDate(task)),
                   status: status
               };

               $.ajax({
                   url: "jsp/UpdateTaskbyID.jsp",
                   type: "POST",
                   data: taskData,
                   success: function(response) {
                       console.log("âœ… ì‘ì—… ì—…ë°ì´íŠ¸ ì„±ê³µ:", response);
                   },
                   error: function(xhr, status, error) {
                       console.error("âŒ ì‘ì—… ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", error);
                       alert("ë³€ê²½ì‚¬í•­ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                       gantt.refreshData(); // ì›ë˜ ìƒíƒœë¡œ ë¡¤ë°±
                   }
               });
           }
        
        // ì‘ì—… ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
           function openTaskModal(task) {
               // ëª¨ë‹¬ í•„ë“œì— ê¸°ì¡´ ë°ì´í„° ì„¸íŒ…
               document.getElementById("taskName").value = task.text;
               document.getElementById("startDate").value = formatDate(task.start_date);
               document.getElementById("endDate").value = formatDate(task.end_date);
               document.getElementById("progress").value = task.progress * 100; // 0-1 ë²”ìœ„ë¥¼ 0-100ìœ¼ë¡œ ë³€í™˜

               // ëª¨ë‹¬ í‘œì‹œ
               document.getElementById("taskModal").style.display = "block";

               // ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ
               document.getElementById("taskForm").onsubmit = function(event) {
                   event.preventDefault(); // ê¸°ë³¸ ì œì¶œ ë°©ì§€
                   updateTask(task.id); // ì‘ì—… ì—…ë°ì´íŠ¸
                   closeTaskModal(); // ëª¨ë‹¬ ë‹«ê¸°
               };
           }

           // ëª¨ë‹¬ ë‹«ê¸°
           function closeTaskModal() {
               document.getElementById("taskModal").style.display = "none";
           }
           
           function updateTask(id) {
        	    // ì…ë ¥ í•„ë“œì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
        	    const taskName = document.getElementById("taskName").value;
        	    const startDate = new Date(document.getElementById("startDate").value);
        	    const endDate = new Date(document.getElementById("endDate").value);
        	    const progress = document.getElementById("progress").value / 100; // 0-100ì„ 0-1ë¡œ ë³€í™˜
				
        	    console.log(document.getElementById("startDate").value);
        		 // ë‚ ì§œ ë³€í™˜
        	    const formattedStartDate = convertDate(startDate.toISOString().split('T')[0]);
    			const formattedEndDate = convertDate(endDate.toISOString().split('T')[0]);
        	    
        	    

        	    // Gantt ì°¨íŠ¸ì—ì„œ ì‘ì—… ì—…ë°ì´íŠ¸
        	    gantt.updateTask(id, {
        	        text: taskName,
        	        start_date: formattedStartDate,
        	        end_date: formattedEndDate,
        	        progress: progress
        	    });

        	    // ë³€ê²½ëœ ì‘ì—… ì •ë³´ë¥¼ ì €ì¥
        	    const updatedTask = {
        	        id: id,
        	        text: taskName,
        	        start_date: startDate,
        	        end_date: endDate,
        	        progress: progress
        	    };

        	    saveTaskChanges(updatedTask); // ì„œë²„ì— ë³€ê²½ ì‚¬í•­ ì €ì¥

        	    // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
        	    alert("ì‘ì—…ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
        	}
           
           // ë‚ ì§œ í¬ë§· ë³€í™˜ í•¨ìˆ˜ (í•„ìš” ì‹œ)
           function formatDate(dateString) {
               const date = new Date(dateString);
               return date.toISOString().split('T')[0]; // YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë³€í™˜
           }

           // ë‹«ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ ë‹«ê¸°
           document.querySelector("#taskModal .close").onclick = closeTaskModal;



        
            });
	

            // ğŸ“Œ í”„ë¡œì íŠ¸ í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê¸°
            $(".gantt-row").on("click", function () {
                const projectId = $(this).data("id");
                $("#projectId").val(projectId);
                $("#scheduleModal").show();
            });
    </script>

</body>
</html>